<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horizontal Math Game</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#4682b4" />
    <link rel="manifest" href="manifest.json" />
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js").catch(console.error);
            });
        }
    </script>
    <audio id="okaySound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/okay.mp3" type="audio/mp3" /></audio>
    <audio id="welldoneSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/welldone.mp3" type="audio/mp3" /></audio>
    <audio id="correctSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/correct.mp3" type="audio/mp3" /></audio>
    <audio id="greatSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/great.mp3" type="audio/mp3" /></audio>
    <audio id="c1Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c1.mp3" type="audio/mp3" /></audio>
    <audio id="c2Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c2.mp3" type="audio/mp3" /></audio>
    <audio id="c3Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c3.mp3" type="audio/mp3" /></audio>
    <audio id="c4Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c4.mp3" type="audio/mp3" /></audio>
    <audio id="c5Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c5.mp3" type="audio/mp3" /></audio>
    <audio id="c6Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c6.mp3" type="audio/mp3" /></audio>
    <audio id="countdownSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/countdown5sec.mp3" type="audio/mp3" /></audio>
    <audio id="cheerSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/cheer.mp3" type="audio/mp3" /></audio>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --blue: #4682b4;
            --green: #32cd32;
            --red: #ff4500;
            --orange: #ff9a00;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f8ff url("https://cdn.pixabay.com/photo/2021/05/20/12/51/fish-6269836_1280.png") no-repeat bottom right / 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: #fff;
            padding: 30px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        h1 {
            color: #ff6347;
            margin: 0 0 15px;
            font-size: 2rem;
        }
        .category-title {
            background-color: #ff69b4;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        .horizontal-question {
            color: var(--blue);
            font-size: 2.4em;
            display: inline-block;
            margin-bottom: 10px;
        }
        .horizontal-question input[type="number"] {
            width: 80px;
            font-size: 1em;
            padding: 5px;
            border: 2px solid var(--green);
            border-radius: 5px;
            margin-left: 10px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        #feedback3, #feedback4 {
            font-size: 1.8em;
            min-height: 1.8em;
            margin-top: 20px;
        }
        .correct {
            color: var(--green);
        }
        .incorrect {
            color: var(--red);
        }
        #score3, #highScore3, #timer3, #score4, #bestTime4, #timeUsed4 {
            font-size: 1.6em;
            color: var(--blue);
        }
        #timer3, #timeUsed4 {
            font-size: 1.9em;
            color: var(--orange);
            margin: 10px 0 0;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1.2em;
            margin: 5px;
        }
        #mistakeBtn3, #leaderBtn3, #mistakeBtn4, #leaderBtn4 {
            background: #eee;
            margin: 0 4px;
        }
        #pauseBtn3, #pauseBtn4 {
            background: #ff6347;
            color: white;
            margin: 0 4px;
        }
        #resumeBtn3, #resumeBtn4 {
            background: #32cd32;
            color: white;
            margin-top: 20px;
        }
        #restartBtn3, #restartBtn4 {
            background: #ffd700;
            padding: 10px 24px;
            font-size: 1.2em;
            margin-top: 25px;
            display: none;
        }
        #soundToggle {
            background: #87ceeb;
            padding: 5px 10px;
            font-size: 1em;
        }
        #mistakes3, #mistakes4 {
            text-align: left;
            margin-top: 25px;
            font-size: 1.4em;
        }
        #mistakes3 .wrong, #mistakes4 .wrong {
            color: var(--red);
        }
        #mistakes3 .correct, #mistakes4 .correct {
            color: var(--green);
        }
        #leaderboard3, #leaderboard4 {
            margin-top: 20px;
            display: none;
        }
        #leaderboard3 ol, #leaderboard4 ol {
            padding-left: 20px;
            margin: 8px 0;
            list-style-type: none;
        }
        #leaderboard3 li, #leaderboard4 li {
            color: var(--blue);
            padding: 5px;
        }
        #leaderboard3 li.me, #leaderboard4 li.me {
            color: var(--red);
            font-weight: bold;
            background-color: #ffe4e1;
            border-radius: 4px;
        }
        #game4 div:nth-child(4) {
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .horizontal-question {
                font-size: 1.8em;
            }
            .horizontal-question input[type="number"] {
                font-size: 0.8em;
                width: 60px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .container {
                padding: 20px 15px;
            }
            button {
                padding: 12px 24px;
                font-size: 1.1em;
                margin: 8px;
            }
            #mistakeBtn3, #leaderBtn3, #mistakeBtn4, #leaderBtn4, #pauseBtn3, #pauseBtn4 {
                margin: 8px;
            }
            #score4, #bestTime4 {
                font-size: 1.2em;
            }
        }
        /* Initially hide game divs until mode is selected by JS */
        #game3, #game4 {
             display: none;
        }
    </style>
</head>
<body>
    <div style="text-align: right; margin-bottom: 10px">
        ğŸ”Š <button id="soundToggle"><span id="soundToggle_en">Sound: On</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: é–‹</span></button> Â 
        ğŸŒ <span id="langLabel_en">Language:</span><span id="langLabel_zh" style="display:none">èªè¨€:</span>
        <select id="langSelect" style="font-size: 1em" aria-label="Select language">
            <option value="en">English</option>
            <option value="zh">ç¹é«”ä¸­æ–‡</option>
        </select>
    </div>

    <div id="game3" class="container">
        <h1><span id="title3_en">Super Speedy Sums Splash!</span><span id="title3_zh" style="display:none">è¶…ç´šå¿«é€ŸåŠ æ³•éŠæˆ²ï¼</span></h1>
        <div class="horizontal-question" aria-live="polite" id="question3">
            <span id="num1_3"></span> + <span id="num2_3"></span> =
            <input type="number" id="answerInput3" min="0" max="99" autocomplete="off" />
        </div>
        <div id="feedback3" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score3"><span id="scoreText3_en">Score: </span><span id="scoreText3_zh" style="display:none">å¾—åˆ†: </span>0</span> Â 
            <span style="color:red">â€¢</span> Â 
            <span id="highScore3"><span id="highScoreText3_en">High Score: </span><span id="highScoreText3_zh" style="display:none">æœ€é«˜åˆ†: </span>0</span>
        </div>
        <div id="timer3"><span id="timerText3_en">Time Left: </span><span id="timerText3_zh" style="display:none">å‰©é¤˜æ™‚é–“ï¼š</span>60s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn3">â¸ï¸ <span id="pauseBtn3_en">Pause</span><span id="pauseBtn3_zh" style="display:none">æš«åœ</span></button>
            <button id="mistakeBtn3"><span id="mistakeBtn3_en">âŒ Mistakes</span><span id="mistakeBtn3_zh" style="display:none">âŒ éŒ¯é¡Œ</span></button>
            <button id="leaderBtn3"><span id="leaderBtn3_en">ğŸ“Š Leaderboard</span><span id="leaderBtn3_zh" style="display:none">ğŸ“Š æ’è¡Œæ¦œ</span></button>
        </div>
        <div id="mistakes3" style="display:none;"></div>
        <div id="leaderboard3">
            <h3><span id="leaderTitle3_en">ğŸ† Top 5 Scores</span><span id="leaderTitle3_zh" style="display:none">ğŸ† å‰ 5 åå¾—åˆ†</span></h3>
            <ol id="leaderList3"></ol>
            <p id="noLeaderData3" style="display:none;color:var(--blue);"><span id="noLeaderData3_en">No leaderboard data available.</span><span id="noLeaderData3_zh" style="display:none">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“šã€‚</span></p>
        </div>
        <button id="restartBtn3"><span id="restartBtn3_en">Play Again</span><span id="restartBtn3_zh" style="display:none">å†ç©ä¸€æ¬¡</span></button>
        <div id="pauseOverlay3" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText3_en">Paused</span><span id="pausedText3_zh" style="display:none">å·²æš«åœ</span><br>
            <button id="resumeBtn3">â–¶ï¸ <span id="resumeBtn3_en">Resume</span><span id="resumeBtn3_zh" style="display:none">ç¹¼çºŒ</span></button>
        </div>
    </div>
<div id="game4" class="container">
        <h1><span id="title4_en">One Hundred Rush</span><span id="title4_zh" style="display:none">æœ€å¿«ä¸€ç™¾åˆ†</span></h1>
        <div class="horizontal-question" aria-live="polite" id="question4">
            <span id="num1_4"></span> + <span id="num2_4"></span> =
            <input type="number" id="answerInput4" min="0" max="99" autocomplete="off" />
        </div>
        <div id="feedback4" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score4"><span id="scoreText4_en">Score: </span><span id="scoreText4_zh" style="display:none">å¾—åˆ†: </span>0</span> Â 
            <span style="color:red">â€¢</span> Â 
            <span id="bestTime4"><span id="bestTimeText4_en">Best Time: </span><span id="bestTimeText4_zh" style="display:none">æœ€ä½³æ™‚é–“: </span>â€“</span>
        </div>
        <div style="margin: 10px auto; width: 80%; background: #ddd; border-radius: 5px;">
            <div id="progressBar4" style="width: 0%; height: 10px; background: var(--green); border-radius: 5px;"></div>
        </div>
        <div id="timeUsed4"><span id="timeUsedText4_en">Time Used: </span><span id="timeUsedText4_zh" style="display:none">å·²ç”¨æ™‚é–“: </span>0.0â€¯s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn4">â¸ï¸ <span id="pauseBtn4_en">Pause</span><span id="pauseBtn4_zh" style="display:none">æš«åœ</span></button>
            <button id="mistakeBtn4"><span id="mistakeBtn4_en">âŒ Mistakes</span><span id="mistakeBtn4_zh" style="display:none">âŒ éŒ¯é¡Œ</span></button>
            <button id="leaderBtn4"><span id="leaderBtn4_en">ğŸ“Š Leaderboard</span><span id="leaderBtn4_zh" style="display:none">ğŸ“Š æ’è¡Œæ¦œ</span></button>
        </div>
        <div id="mistakes4" style="display:none;"></div>
        <div id="leaderboard4">
            <h3><span id="leaderTitle4_en">ğŸ† Top 5 Fastest</span><span id="leaderTitle4_zh" style="display:none">ğŸ† å‰ 5 åæœ€å¿«</span></h3>
            <ol id="leaderList4"></ol>
            <p id="noLeaderData4" style="display:none;color:var(--blue);"><span id="noLeaderData4_en">No leaderboard data available.</span><span id="noLeaderData4_zh" style="display:none">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“šã€‚</span></p>
        </div>
        <button id="restartBtn4"><span id="restartBtn4_en">Play Again</span><span id="restartBtn4_zh" style="display:none">å†ç©ä¸€æ¬¡</span></button>
        <div id="pauseOverlay4" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText4_en">Paused</span><span id="pausedText4_zh" style="display:none">å·²æš«åœ</span><br>
            <button id="resumeBtn4">â–¶ï¸ <span id="resumeBtn4_en">Resume</span><span id="resumeBtn4_zh" style="display:none">ç¹¼çºŒ</span></button>
        </div>
    </div>

    <script>
         // Shared Setup
        const username = (() => {
            let n = localStorage.getItem("username");
            if (!n) {
                const lang = document.querySelector("#langSelect").value;
                n = prompt(lang === "en" ? "Your name?" : "è«‹è¼¸å…¥ä½ çš„åå­—ï¼š") || "Anonymous";
                localStorage.setItem("username", n);
            }
            return n; // Corrected: return n instead of username
        })();

        firebase.initializeApp({
            apiKey: "AIzaSyB-qOLia1TQAeK3U_HrJZJ7M4ePlJkS2Ik",
            authDomain: "speedsums-621b2.firebaseapp.com",
            projectId: "speedsums-621b2",
            storageBucket: "speedsums-621b2.appspot.com",
            messagingSenderId: "812641533469",
            appId: "1:812641533469:web:c3fe978e04f48cb3bf50f4"
        });
        const db = firebase.database();

        const q = s => document.querySelector(s);

        // Sound Toggle
        let soundEnabled = true;
        const soundToggleBtn = q("#soundToggle");
         if (soundToggleBtn) { // Add check if element exists
            soundToggleBtn.addEventListener("click", () => {
                soundEnabled = !soundEnabled;
                const lang = q("#langSelect").value;
                soundToggleBtn.innerHTML = lang === "en" ?
                    `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>` :
                    `<span id="soundToggle_en" style="display:none">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>`;
            });
        }


        function playRandomCorrectSound() {
            if (!soundEnabled) return;
            const correctSounds = [
                q("#okaySound"), q("#welldoneSound"), q("#correctSound"), q("#greatSound"),
                q("#c1Sound"), q("#c2Sound"), q("#c3Sound"), q("#c4Sound"), q("#c5Sound"), q("#c6Sound")
            ];
            const randomSound = correctSounds[Math.floor(Math.random() * correctSounds.length)];
             if (randomSound) { // Check if the element exists
                 try { randomSound.currentTime = 0; randomSound.play(); } catch(e) { console.error("Sound playback error:", e); }
             }
        }

        // Language Persistence
        const langSelect = q("#langSelect");
        const savedLang = localStorage.getItem("lang") || "en";
        if (langSelect) { // Add check if element exists
             langSelect.value = savedLang;
        }


        function switchLang() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            document.querySelectorAll("[id$='_en']").forEach(el => el.style.display = lang === "en" ? "inline" : "none");
            document.querySelectorAll("[id$='_zh']").forEach(el => el.style.display = lang === "zh" ? "inline" : "none");

            // Update specific elements that need language adjustments for Game 3
            updateScore3();
            updateHighScore3();
            updateTimer3(); // Update timer display format
            if (q("#mistakes3") && q("#mistakes3").style.display === "block") showMistakes3();
            if (q("#leaderboard3") && q("#leaderboard3").style.display === "block") refreshLeaderboard3();

            // Update specific elements that need language adjustments for Game 4
            updateScore4();
            updateTimer4(); // Update timer display format
            const bestEl4 = q("#bestTime4"); // Re-get the element
            if(bestEl4) {
                 bestEl4.innerHTML = `<span id="bestTimeText4_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText4_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€ä½³æ™‚é–“: </span>${bestTime4 ? bestTime4.toFixed(1) + ' s' : 'â€“'}`; // Use toFixed(1)
            }

            if (q("#mistakes4") && q("#mistakes4").style.display === "block") showMistakes4();
            if (q("#leaderboard4") && q("#leaderboard4").style.display === "block") refreshLeaderboard4();

            // Update sound toggle text
            const soundToggleBtn = q("#soundToggle");
            if (soundToggleBtn) { // Check element exists
                soundToggleBtn.innerHTML = lang === "en" ?
                    `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>` :
                    `<span id="soundToggle_en" style="display:none">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>`;
            }
        }

        if (langSelect) { // Add check if element exists
             langSelect.addEventListener("change", () => {
                 localStorage.setItem("lang", langSelect.value);
                 switchLang();
             });
        }


        // --- Game 3 Variables and Functions ---
        let score3 = 0, timeLeft3 = 60, highScore3 = parseInt(localStorage.getItem("highScore3") || 0), timer3, mistakes3 = [], num1_3, num2_3, myLastScore3 = null;
        let isPaused3 = false;
        const num1El3 = q("#num1_3"), num2El3 = q("#num2_3"), ansInp3 = q("#answerInput3"),
              scoreEl3 = q("#score3"), timerEl3 = q("#timer3"), highScoreEl3 = q("#highScore3"), fbk3 = q("#feedback3"),
              mistakesDiv3 = q("#mistakes3"), leaderDiv3 = q("#leaderboard3"), leaderList3 = q("#leaderList3"), noLeaderData3 = q("#noLeaderData3");

        function updateScore3() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if(scoreEl3) { // Check element exists
                 scoreEl3.innerHTML = `<span id="scoreText3_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText3_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å¾—åˆ†: </span>${score3}`;
             }
        }

        function updateHighScore3() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if(highScoreEl3) { // Check element exists
                 highScoreEl3.innerHTML = `<span id="highScoreText3_en" style="display:${lang === 'en' ? 'inline' : 'none'}">High Score: </span><span id="highScoreText3_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€é«˜åˆ†: </span>${highScore3}`;
             }
        }

        function updateTimer3() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if(timerEl3) { // Check element exists
                 timerEl3.innerHTML = `<span id="timerText3_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Left: </span><span id="timerText3_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å‰©é¤˜æ™‚é–“ï¼š</span>${timeLeft3}s`;
             }
        }

        function generateQuestion3() {
            do {
                num1_3 = Math.floor(Math.random() * 90) + 10;
                num2_3 = Math.floor(Math.random() * 90) + 10;
            } while (num1_3 + num2_3 > 99);
            if(num1El3) num1El3.textContent = num1_3;
            if(num2El3) num2El3.textContent = num2_3;
            if (ansInp3) { ansInp3.value = ""; ansInp3.focus(); }
            if (fbk3) fbk3.textContent = "";
        }

        function checkAnswer3(userAnswer) {
            if (!ansInp3 || ansInp3.value.length < 2) return; // Check ansInp3 exists and has enough input
            const correctAnswer = num1_3 + num2_3;

             // Immediately clear input after getting the answer
             ansInp3.value = "";

            if (fbk3) { // Check fbk3 exists before updating feedback
                if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                    const correctEmojis = ['ğŸŸ', 'âœ¨', 'ğŸ‰'];
                    const randomCorrect = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                    fbk3.innerHTML = userAnswer + ' <span class="correct">âœ”' + randomCorrect + '</span>';
                    score3 += 3;
                    updateScore3();
                    playRandomCorrectSound();
                } else {
                    const wrongEmojis = ['ğŸ˜µ', 'ğŸ’¦'];
                    const randomWrong = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
                    fbk3.innerHTML = userAnswer + ' <span class="incorrect">âœ˜' + randomWrong + '</span>';
                    mistakes3.push({
                        question: `${num1_3} + ${num2_3}`,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer
                    });
                    score3 = Math.max(0, score3 - 1);
                    updateScore3();
                }
            }
             // Generate next question immediately after check
             generateQuestion3();
        }


        function showMistakes3() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if (!mistakesDiv3 || !leaderDiv3) return; // Exit if elements don't exist
            mistakesDiv3.innerHTML = `<h3><span id="mistakesTitle3_en" style="display:${lang === 'en' ? 'block' : 'none'}">âŒ Mistakes</span><span id="mistakesTitle3_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">âŒ éŒ¯é¡Œ</span></h3>`;
            if (mistakes3.length === 0) {
                mistakesDiv3.innerHTML += `<p><span id="noMistakes3_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! ğŸ‰</span><span id="noMistakes3_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">æ²’æœ‰éŒ¯èª¤ï¼ğŸ‰</span></p>`;
            } else {
                mistakes3.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.question} = <span class="wrong">${m.userAnswer}</span>, <span class="correct">${m.correctAnswer}</span>`;
                    mistakesDiv3.appendChild(div);
                });
            }
            mistakesDiv3.style.display = "block";
            leaderDiv3.style.display = "none";
        }

        function refreshLeaderboard3() {
             if (!leaderDiv3 || !leaderList3 || !noLeaderData3) return; // Exit if elements don't exist
            db.ref("scores3").orderByChild("score").limitToLast(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.score === "number" && !isNaN(val.score) && val.timestamp) {
                        arr.push({ name: val.name, score: val.score, timestamp: val.timestamp });
                    }
                });

                 const virtualData3 = [
                    { name: "Alex", score: 60, timestamp: Date.now() - 1000 },
                    { name: "æ˜", score: 52, timestamp: Date.now() - 2000 },
                    { name: "Kitty Chow", score: 45, timestamp: Date.now() - 3000 },
                    { name: "Tommy Lee", score: 38, timestamp: Date.now() - 4000 },
                    { name: "å‘€å¯¶", score: 30, timestamp: Date.now() - 5000 }
                ];
                 let combinedArr = [...arr];
                 if (myLastScore3 !== null) {
                     const userEntry = combinedArr.find(entry => entry.name === username && entry.score === myLastScore3);
                     if (!userEntry) { // Only add if user's last score isn't already in the fetched top scores
                         combinedArr.push({ name: username, score: myLastScore3, timestamp: Date.now() });
                     }
                 }

                 combinedArr.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); // Sort by score desc, then time asc

                 const top5Map = new Map(); // Use Map to get unique entries based on name+score
                 for(const entry of combinedArr) {
                      const key = `${entry.name}-${entry.score}`; // Use name+score as key for uniqueness
                      if (!top5Map.has(key)) {
                           top5Map.set(key, entry);
                      }
                      if (top5Map.size >= 5) break; // Stop once we have 5 unique entries
                 }
                 const top5Arr = Array.from(top5Map.values());


                 const currentTopCount = top5Arr.length;
                 if (currentTopCount < 5) {
                     const virtualToAdd = virtualData3.filter(vEntry =>
                         !top5Arr.some(rEntry => rEntry.name === vEntry.name && rEntry.score === vEntry.score) // Avoid adding duplicates of real/user scores
                     ).slice(0, 5 - currentTopCount);
                     top5Arr.push(...virtualToAdd);
                      top5Arr.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); // Re-sort after adding virtual data
                 }

                if (top5Arr.length === 0) {
                     leaderList3.innerHTML = "";
                     noLeaderData3.style.display = "block";
                } else {
                     leaderList3.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < top5Arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (top5Arr[i].score === top5Arr[i - 1].score) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }
                    top5Arr.slice(0, 5).forEach((entry, i) => {
                         if(leaderList3) { // Check again before appending
                            const li = document.createElement("li");
                            const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "";
                            li.textContent = `${ranks[i]}. ${entry.name} â€“ ${entry.score} ${medal}`;
                            if (entry.name === username && entry.score === myLastScore3 && myLastScore3 !== null) {
                                li.classList.add("me");
                            }
                            leaderList3.appendChild(li);
                         }
                    });
                     noLeaderData3.style.display = "none";
                }
                 if (leaderDiv3) leaderDiv3.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                 if(leaderList3) leaderList3.innerHTML = "";
                 if(noLeaderData3) noLeaderData3.style.display = "block";
            });
        }

        function startTimer3() {
             if (!timerEl3) return; // Exit if element doesn't exist
            timer3 = setInterval(() => {
                if (isPaused3) return;
                timeLeft3--;
                updateTimer3();
                if (timeLeft3 === 5 && soundEnabled) {
                     try { q("#countdownSound").currentTime = 0; q("#countdownSound").play(); } catch(e) { console.error("Countdown sound error:", e); }
                }
                if (timeLeft3 <= 0) {
                    clearInterval(timer3);
                    const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
                    if (fbk3) fbk3.textContent = lang === "en" ? "Time's up! ğŸ•’" : "æ™‚é–“åˆ°ï¼ğŸ•’";
                    if (ansInp3) ansInp3.disabled = true;
                    myLastScore3 = score3; // Store score to highlight on leaderboard
                    db.ref("scores3").push({ name: username, score: score3, timestamp: Date.now() }).then(() => {
                        refreshLeaderboard3(); // Refresh after saving
                        if (score3 > highScore3) {
                            highScore3 = score3;
                            localStorage.setItem("highScore3", highScore3);
                            updateHighScore3();
                            if (soundEnabled) { try { q("#cheerSound").currentTime = 0; q("#cheerSound").play(); } catch(e) { console.error("Cheer sound error:", e); } }
                        }
                        if (q("#restartBtn3")) q("#restartBtn3").style.display = "inline-block";
                         // Automatically show leaderboard or mistakes after game ends
                         if (mistakes3.length > 0) {
                              showMistakes3();
                         } else {
                              refreshLeaderboard3();
                         }
                    }).catch(error => {
                        console.error("Error saving score:", error);
                        if (fbk3) fbk3.textContent = lang === "en" ? "Error saving to leaderboard." : "ç„¡æ³•ä¿å­˜åˆ°æ’è¡Œæ¦œã€‚";
                        if (q("#restartBtn3")) q("#restartBtn3").style.display = "inline-block";
                         // Still show mistakes if any, even if leaderboard save fails
                         if (mistakes3.length > 0) {
                              showMistakes3();
                         }
                    });
                }
            }, 1000);
        }


        function startGame3() {
            score3 = 0;
            timeLeft3 = 60;
            mistakes3 = [];
            myLastScore3 = null; // Reset last score
            isPaused3 = false;
            clearInterval(timer3); // Clear any existing timer
            updateScore3();
            updateTimer3();
             if(mistakesDiv3) mistakesDiv3.style.display = "none";
             if(leaderDiv3) leaderDiv3.style.display = "none";
             if(leaderList3) leaderList3.innerHTML = "";
             if(noLeaderData3) noLeaderData3.style.display = "none";
             if(q("#restartBtn3")) q("#restartBtn3").style.display = "none";
             if(q("#pauseOverlay3")) q("#pauseOverlay3").style.display = "none";
            if (ansInp3) ansInp3.disabled = false;
            if (fbk3) fbk3.textContent = "";
            generateQuestion3();
            startTimer3();
             if (ansInp3) ansInp3.focus(); // Ensure input is focused at start
        }

        if (ansInp3) { // Add listener only if element exists
             ansInp3.addEventListener("input", e => {
                 // Limit input to 2 digits
                if (e.target.value.length > 2) {
                    e.target.value = e.target.value.slice(0, 2);
                }
                const val = parseInt(e.target.value, 10);
                 // Check answer only when input length is 2
                if (e.target.value.length === 2 && !isNaN(val)) {
                     checkAnswer3(val);
                }
            });
             // Allow checking answer by pressing Enter
             ansInp3.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const val = parseInt(ansInp3.value, 10);
                     if (!isNaN(val)) {
                          checkAnswer3(val);
                     }
                     e.preventDefault(); // Prevent default form submission if inside a form
                }
             });
        }

        if (q("#mistakeBtn3")) { // Add listener only if element exists
             q("#mistakeBtn3").addEventListener("click", () => {
                if (mistakesDiv3 && leaderDiv3) {
                    if (mistakesDiv3.style.display === "block") {
                        mistakesDiv3.style.display = "none";
                    } else {
                        showMistakes3();
                        leaderDiv3.style.display = "none"; // Hide leaderboard if showing mistakes
                    }
                }
            });
        }

        if (q("#leaderBtn3")) { // Add listener only if element exists
            q("#leaderBtn3").addEventListener("click", () => {
                if (leaderDiv3 && mistakesDiv3 && noLeaderData3) {
                    if (leaderDiv3.style.display === "block") {
                        leaderDiv3.style.display = "none";
                        noLeaderData3.style.display = "none";
                    } else {
                        refreshLeaderboard3();
                        mistakesDiv3.style.display = "none"; // Hide mistakes if showing leaderboard
                    }
                }
            });
        }

        if (q("#pauseBtn3")) { // Add listener only if element exists
            q("#pauseBtn3").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay3");
                 if (pauseOverlay && ansInp3) {
                    isPaused3 = true;
                    clearInterval(timer3);
                    pauseOverlay.style.display = "block";
                    ansInp3.disabled = true; // Disable input when paused
                 }
            });
        }

        if (q("#resumeBtn3")) { // Add listener only if element exists
            q("#resumeBtn3").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay3");
                 if (pauseOverlay && ansInp3) {
                    isPaused3 = false;
                    pauseOverlay.style.display = "none";
                    startTimer3();
                    ansInp3.disabled = false; // Re-enable input
                    ansInp3.focus(); // Focus input after resuming
                 }
            });
        }

        if (q("#restartBtn3")) { // Add listener only if element exists
            q("#restartBtn3").addEventListener("click", () => {
                 // This button should ideally navigate back to index.html
                 window.location.href = 'index.html';
                // Or if staying on the page to restart, call startGame3()
                // startGame3(); // If restarting on the same page
            });
        }

        // --- Game 4 Variables and Functions ---
        const TARGET_SCORE4 = 100, CORRECT_POINTS4 = 3, WRONG_POINTS4 = -1;
        let score4 = 0, timeUsed4 = 0, bestTime4 = parseFloat(localStorage.getItem("bestTime4")) || null, timer4, mistakes4 = [], num1_4, num2_4, myLastTime4 = null;
        let isPaused4 = false, gameStarted4 = false;
        const num1El4 = q("#num1_4"), num2El4 = q("#num2_4"), ansInp4 = q("#answerInput4"), ansFld4 = q("#answer4"),
              scoreEl4 = q("#score4"), timeEl4 = q("#timeUsed4"), bestEl4 = q("#bestTime4"), fbk4 = q("#feedback4"),
              progressBar4 = q("#progressBar4"), mistakesDiv4 = q("#mistakes4"), leaderDiv4 = q("#leaderboard4"),
              leaderList4 = q("#leaderList4"), noLeaderData4 = q("#noLeaderData4");

        function updateScore4() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            score4 = Math.max(0, score4); // Ensure score doesn't go below 0
             if(scoreEl4) { // Check element exists
                scoreEl4.innerHTML = `<span id="scoreText4_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText4_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å¾—åˆ†: </span>${score4}`;
             }
             if(progressBar4) { // Check element exists
                 progressBar4.style.width = `${Math.min(100, (score4 / TARGET_SCORE4) * 100)}%`; // Cap progress at 100%
                 progressBar4.style.backgroundColor = score4 >= TARGET_SCORE4 ? 'var(--green)' : 'var(--orange)'; // Change color when target reached
             }
        }

        function updateTimer4() {
             if (!timeEl4 || !gameStarted4) return; // Exit if elements don't exist or game hasn't started
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             // Calculate time since startGame4 was called
             const elapsed = isPaused4 ? timeUsed4 : (Date.now() - (startTime4 - timeUsed4 * 1000)) / 1000;
             timeUsed4 = elapsed; // Update timeUsed4 for pause/resume logic
            timeEl4.innerHTML = `<span id="timeUsedText4_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Used: </span><span id="timeUsedText4_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å·²ç”¨æ™‚é–“: </span>${timeUsed4.toFixed(1)}â€¯s`;
        }

        function generateQuestion4() {
            do {
                num1_4 = Math.floor(Math.random() * 90) + 10;
                num2_4 = Math.floor(Math.random() * 90) + 10;
            } while (num1_4 + num2_4 > 99);

             // Display numbers using the new vertical format
            if(num1El4) num1El4.textContent = num1_4;
            if(num2El4) num2El4.textContent = "+ " + num2_4;


            if (ansInp4) { ansInp4.value = ""; ansInp4.focus(); }
            if (fbk4) fbk4.textContent = "";
            if (ansFld4) ansFld4.textContent = ""; // Clear previous answer in the vertical format
        }

        function checkAnswer4(userAnswer) {
             if (!ansInp4 || ansInp4.value.length < 2) return; // Check ansInp4 exists and has enough input
            const correctAnswer = num1_4 + num2_4;

             // Immediately clear input after getting the answer
             ansInp4.value = "";

            if (ansFld4) { // Check ansFld4 exists before updating the vertical answer
                if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                    const correctEmojis = ['ğŸŸ', 'âœ¨', 'ğŸ‰'];
                    const randomCorrect = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                    ansFld4.innerHTML = userAnswer + ' <span class="correct">âœ”' + randomCorrect + '</span>'; // Update answer field in vertical format
                    score4 += CORRECT_POINTS4;
                    updateScore4();
                    playRandomCorrectSound();
                    if (score4 >= TARGET_SCORE4) {
                        finishGame4();
                        return; // Exit after finishing
                    }
                } else {
                    const wrongEmojis = ['ğŸ˜µ', 'ğŸ’¦'];
                    const randomWrong = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
                    ansFld4.innerHTML = userAnswer + ' <span class="incorrect">âœ˜' + randomWrong + '</span>'; // Update answer field in vertical format
                    mistakes4.push({
                        question: `${num1_4} + ${num2_4}`,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer
                    });
                    score4 = Math.max(0, score4 + WRONG_POINTS4);
                    updateScore4();
                }
            }
             // Generate next question after a short delay if game is not finished
             if (score4 < TARGET_SCORE4) {
                 setTimeout(generateQuestion4, 500);
             }
        }


        function showMistakes4() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if (!mistakesDiv4 || !leaderDiv4) return; // Exit if elements don't exist
            mistakesDiv4.innerHTML = `<h3><span id="mistakesTitle4_en" style="display:${lang === 'en' ? 'block' : 'none'}">âŒ Mistakes</span><span id="mistakesTitle4_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">âŒ éŒ¯é¡Œ</span></h3>`;
            if (mistakes4.length === 0) {
                mistakesDiv4.innerHTML += `<p><span id="noMistakes4_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! ğŸ‰</span><span id="noMistakes4_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">æ²’æœ‰éŒ¯èª¤ï¼ğŸ‰</span></p>`;
            } else {
                mistakes4.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.question} = <span class="wrong">${m.userAnswer}</span>, <span class="correct">${m.correctAnswer}</span>`;
                    mistakesDiv4.appendChild(div);
                });
            }
            mistakesDiv4.style.display = "block";
            leaderDiv4.style.display = "none";
        }

        function refreshLeaderboard4() {
             if (!leaderDiv4 || !leaderList4 || !noLeaderData4) return; // Exit if elements don't exist
            // This game uses 'times2' path based on previous file content
            db.ref("times2").orderByChild("time").limitToFirst(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.time === "number" && !isNaN(val.time) && val.timestamp) {
                        arr.push({ name: val.name, time: val.time, timestamp: val.timestamp });
                    }
                });

                 const virtualData4 = [
                    { name: "Alex", time: 85.2, timestamp: Date.now() - 1000 },
                    { name: "æ˜", time: 98.1, timestamp: Date.now() - 2000 },
                    { name: "Kitty Chow", time: 115.7, timestamp: Date.now() - 3000 },
                    { name: "Tommy Lee", time: 123.5, timestamp: Date.now() - 4000 },
                    { name: "å‘€å¯¶", time: 159.7, timestamp: Date.now() - 5000 }
                ];
                 let combinedArr = [...arr];
                 if (myLastTime4 !== null) {
                     const userEntry = combinedArr.find(entry => entry.name === username && entry.time === myLastTime4);
                      if (!userEntry) { // Only add if user's last time isn't already in the fetched top times
                           combinedArr.push({ name: username, time: myLastTime4, timestamp: Date.now() });
                       }
                 }

                 combinedArr.sort((a, b) => a.time - b.time || a.ts - b.ts); // Sort by time asc, then timestamp asc

                 const top5Map = new Map(); // Use Map to get unique entries based on name+time
                 for(const entry of combinedArr) {
                      const key = `${entry.name}-${entry.time}`; // Use name+time as key for uniqueness
                      if (!top5Map.has(key)) {
                           top5Map.set(key, entry);
                      }
                      if (top5Map.size >= 5) break; // Stop once we have 5 unique entries
                 }
                 const top5Arr = Array.from(top5Map.values());


                 const currentTopCount = top5Arr.length;
                 if (currentTopCount < 5) { // Fill up to 5
                     const virtualToAdd = virtualData4.filter(vEntry =>
                         !top5Arr.some(rEntry => rEntry.name === vEntry.name && rEntry.time === vEntry.time) // Avoid adding duplicates
                     ).slice(0, 5 - currentTopCount);
                     top5Arr.push(...virtualToAdd);
                     top5Arr.sort((a, b) => a.time - b.time || a.ts - b.ts); // Re-sort
                 }


                if (top5Arr.length === 0) {
                    leaderList4.innerHTML = "";
                    noLeaderData4.style.display = "block";
                } else {
                     leaderList4.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < top5Arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (top5Arr[i].time === top5Arr[i - 1].time) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }

                    top5Arr.slice(0, 5).forEach((entry, i) => {
                        if(leaderList4) { // Check element exists
                            const li = document.createElement("li");
                            const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "";
                            li.textContent = `${ranks[i]}. ${entry.name} â€“ ${entry.time.toFixed(1)}s ${medal}`;
                            if (entry.name === username && entry.time === myLastTime4 && myLastTime4 !== null) {
                                li.classList.add("me");
                            }
                            leaderList4.appendChild(li);
                         }
                    });
                    noLeaderData4.style.display = "none";
                }
                 if (leaderDiv4) leaderDiv4.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                 if(leaderList4) leaderList4.innerHTML = "";
                 if(noLeaderData4) noLeaderData4.style.display = "block";
            });
        }


        function finishGame4() {
             if (!timeUsed4 || !fbk4 || !ansInp4 || !q("#restartBtn4")) return; // Exit if elements don't exist
            clearInterval(timer4);
            ansInp4.disabled = true;
            const tSec = timeUsed4.toFixed(1); // Use the current timeUsed4
            myLastTime4 = parseFloat(tSec);
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            fbk4.innerHTML = `<span style="color:var(--orange);font-size:1.4em">${lang === 'en' ? 'Finished in' : 'å®Œæˆæ™‚é–“'}: ${tSec}â€¯s</span>`;
            q("#restartBtn4").style.display = "inline-block";
            if (!bestTime4 || myLastTime4 < bestTime4) { // Compare myLastTime4 (parseFloat)
                bestTime4 = myLastTime4;
                localStorage.setItem("bestTime4", bestTime4);
                 if(bestEl4) { // Check element exists
                     bestEl4.innerHTML = `<span id="bestTimeText4_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText4_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€ä½³æ™‚é–“: </span>${bestTime4.toFixed(1)} s`; // Use toFixed(1)
                 }
                if (soundEnabled) { try { q("#cheerSound").currentTime = 0; q("#cheerSound").play(); } catch(e) { console.error("Cheer sound error:", e); } }
            }
            // Use 'times2' path for this game
            db.ref("times2").push({ name: username, time: parseFloat(tSec), timestamp: Date.now() }).then(() => {
                refreshLeaderboard4();
                 // Automatically show leaderboard or mistakes after game ends
                 if (mistakes4.length > 0) {
                      showMistakes4();
                 } else {
                      refreshLeaderboard4();
                 }
            }).catch(error => {
                console.error("Error saving time:", error);
                fbk4.innerHTML += `<br><span style="color:var(--red)">${lang === 'en' ? 'Error saving to leaderboard.' : 'ç„¡æ³•ä¿å­˜åˆ°æ’è¡Œæ¦œã€‚'}</span>`;
                 // Still show mistakes if any, even if leaderboard save fails
                 if (mistakes4.length > 0) {
                      showMistakes4();
                 }
            });
        }


        function startGame4() {
            score4 = 0;
            timeUsed4 = 0; // Reset time used
            mistakes4 = [];
            myLastTime4 = null; // Reset last time
            isPaused4 = false;
            gameStarted4 = true;
            updateScore4();
            updateTimer4();
             if(mistakesDiv4) mistakesDiv4.style.display = "none";
             if(leaderDiv4) leaderDiv4.style.display = "none";
             if(leaderList4) leaderList4.innerHTML = "";
             if(noLeaderData4) noLeaderData4.style.display = "none";
             if(q("#restartBtn4")) q("#restartBtn4").style.display = "none";
             if(q("#pauseOverlay4")) q("#pauseOverlay4").style.display = "none";
            if (ansInp4) ansInp4.disabled = false;
            if (fbk4) fbk4.textContent = "";
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if(bestEl4) { // Check element exists
                bestEl4.innerHTML = `<span id="bestTimeText4_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText4_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€ä½³æ™‚é–“: </span>${bestTime4 ? bestTime4.toFixed(1) + ' s' : 'â€“'}`; // Use toFixed(1)
             }
            startTime4 = Date.now(); // Start the timer
            clearInterval(timer4); // Clear any existing timer
             timer4 = setInterval(() => {
                if (!isPaused4) updateTimer4();
            }, 100); // Update every 0.1 second
            generateQuestion4();
             if (ansInp4) ansInp4.focus(); // Ensure input is focused at start
        }


        if (ansInp4) { // Add listener only if element exists
            ansInp4.addEventListener("input", e => {
                 // Limit input to 2 digits
                if (e.target.value.length > 2) {
                    e.target.value = e.target.value.slice(0, 2);
                }
                const val = parseInt(e.target.value, 10);
                // Check answer only when input length is 2
                if (e.target.value.length === 2 && !isNaN(val)) {
                     checkAnswer4(val);
                }
            });
             // Allow checking answer by pressing Enter
             ansInp4.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const val = parseInt(ansInp4.value, 10);
                     if (!isNaN(val)) {
                          checkAnswer4(val);
                     }
                     e.preventDefault(); // Prevent default form submission if inside a form
                }
             });
        }


        if (q("#mistakeBtn4")) { // Add listener only if element exists
             q("#mistakeBtn4").addEventListener("click", () => {
                if (mistakesDiv4 && leaderDiv4) {
                    if (mistakesDiv4.style.display === "block") {
                        mistakesDiv4.style.display = "none";
                    } else {
                        showMistakes4();
                        leaderDiv4.style.display = "none";
                    }
                }
            });
        }

        if (q("#leaderBtn4")) { // Add listener only if element exists
             q("#leaderBtn4").addEventListener("click", () => {
                 if (leaderDiv4 && mistakesDiv4 && noLeaderData4) {
                    if (leaderDiv4.style.display === "block") {
                        leaderDiv4.style.display = "none";
                        noLeaderData4.style.display = "none";
                    } else {
                        refreshLeaderboard4();
                        mistakesDiv4.style.display = "none";
                    }
                }
            });
        }

        if (q("#pauseBtn4")) { // Add listener only if element exists
            q("#pauseBtn4").addEventListener("click", () => {
                const pauseOverlay = q("#pauseOverlay4");
                 if (pauseOverlay && ansInp4) {
                    isPaused4 = true;
                    clearInterval(timer4);
                    pauseOverlay.style.display = "block";
                    ansInp4.disabled = true; // Disable input when paused
                 }
            });
        }

        if (q("#resumeBtn4")) { // Add listener only if element exists
            q("#resumeBtn4").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay4");
                 if (pauseOverlay && ansInp4) {
                    isPaused4 = false;
                    pauseOverlay.style.display = "none";
                    // Restart the interval timer
                     startTime4 = Date.now() - timeUsed4 * 1000; // Adjust start time to account for pause duration
                     timer4 = setInterval(() => {
                         if (!isPaused4) updateTimer4();
                     }, 100);
                    ansInp4.disabled = false; // Re-enable input
                    ansInp4.focus(); // Focus input after resuming
                 }
            });
        }

        if (q("#restartBtn4")) { // Add listener only if element exists
            q("#restartBtn4").addEventListener("click", () => {
                 // This button should ideally navigate back to index.html
                 window.location.href = 'index.html';
                // Or if staying on the page to restart, call startGame4()
                // startGame4(); // If restarting on the same page
            });
        }

         // --- Initialisation based on URL Hash ---
        // Find the game divs
        const game3Div = q("#game3");
        const game4Div = q("#game4");

        // Function: Hide all game divs initially
        function hideAllGames() {
            if(game3Div) game3Div.style.display = 'none';
            if(game4Div) game4Div.style.display = 'none';
        }

        // Function: Start game based on mode from URL hash
        function startGameByMode() {
            hideAllGames(); // Hide everything first

            const hash = window.location.hash; // Get hash from URL

            if (hash === '#mode=1min') {
                // Start 2-Digit Vertical 1 Minute Game
                if(game3Div) game3Div.style.display = 'block';
                startGame3(); // Call existing startGame3 function
            } else if (hash === '#mode=100pts') {
                // Start 2-Digit Vertical 100 Points Game
                 if(game4Div) game4Div.style.display = 'block';
                startGame4(); // Call existing startGame4 function
            } else {
                // If no valid hash, redirect to index.html
                 console.warn("No valid game mode specified in URL hash. Redirecting to index.html");
                 window.location.href = 'index.html'; // Redirect to the main menu
            }
            // switchLang() is called at the end of the script
            // Ensure initial focus if a game is started
            if(game3Div && game3Div.style.display === 'block') {
                const ansInput3 = q("#answerInput3");
                if (ansInput3) ansInput3.focus();
            }
            if(game4Div && game4Div.style.display === 'block') {
                 const ansInput4 = q("#answerInput4");
                 if (ansInput4) ansInput4.focus();
            }
        }

        // Call startGameByMode when the DOM is ready
        document.addEventListener('DOMContentLoaded', startGameByMode);

        // Ensure language is applied on load
        switchLang();

         // Initial state: hide games until startGameByMode runs
        hideAllGames();

    </script>
</body>
</html>