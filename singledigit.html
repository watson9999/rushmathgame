<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Math Game Hub</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#4682b4" />
    <link rel="manifest" href="manifest.json" />
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js")
                    .catch(console.error);
            });
        }
    </script>

    <audio id="okaySound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/okay.mp3" type="audio/mp3" /></audio>
    <audio id="welldoneSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/welldone.mp3" type="audio/mp3" /></audio>
    <audio id="correctSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/correct.mp3" type="audio/mp3" /></audio>
    <audio id="greatSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/great.mp3" type="audio/mp3" /></audio>
    <audio id="c1Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c1.mp3" type="audio/mp3" /></audio>
    <audio id="c2Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c2.mp3" type="audio/mp3" /></audio>
    <audio id="c3Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c3.mp3" type="audio/mp3" /></audio>
    <audio id="c4Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c4.mp3" type="audio/mp3" /></audio>
    <audio id="c5Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c5.mp3" type="audio/mp3" /></audio>
    <audio id="c6Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c6.mp3" type="audio/mp3" /></audio>
    <audio id="countdownSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/countdown5sec.mp3" type="audio/mp3" /></audio>
    <audio id="cheerSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/cheer.mp3" type="audio/mp3" /></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --blue: #4682b4;
            --green: #32cd32;
            --red: #ff4500;
            --orange: #ff9a00;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f8ff url("https://cdn.pixabay.com/photo/2021/05/20/12/51/fish-6269836_1280.png") no-repeat bottom right / 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: #fff;
            padding: 30px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        h1 {
            color: #ff6347;
            margin: 0 0 15px;
            font-size: 2rem;
        }
        .question {
            font-size: 3.6em;
            margin: 25px 0;
            color: var(--blue);
            white-space: nowrap;
        }
        .question span {
            display: inline-block;
            min-width: 55px;
            text-align: center;
        }
        input[type="number"] {
            font-size: 2.4em;
            padding: 10px;
            width: 120px;
            text-align: center;
            border: 2px solid var(--green);
            border-radius: 8px;
        }
        #feedback1, #feedback2 {
            font-size: 1.8em;
            min-height: 1.8em;
            margin-top: 20px;
        }
        .correct {
            color: var(--green);
        }
        .incorrect {
            color: var(--red);
        }
        #score1, #highScore1, #timer1, #score2, #bestTime2, #timeUsed2 {
            font-size: 1.6em;
            color: var(--blue);
        }
        #timeUsed2, #timer1 {
            font-size: 1.9em;
            color: var(--orange);
            margin: 10px 0 0;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1.2em;
            margin: 5px;
        }
        #mistakeBtn1, #leaderBtn1, #mistakeBtn2, #leaderBtn2 {
            background: #eee;
            margin: 0 4px;
        }
        #pauseBtn1, #pauseBtn2 {
            background: #ff6347;
            color: white;
            margin: 0 4px;
        }
        #resumeBtn1, #resumeBtn2 {
            background: #32cd32;
            color: white;
            margin-top: 20px;
        }
        #restartBtn1, #restartBtn2 {
            background: #ffd700;
            padding: 10px 24px;
            font-size: 1.2em;
            margin-top: 25px;
            display: none;
        }
        #soundToggle {
            background: #87ceeb;
            padding: 5px 10px;
            font-size: 1em;
        }
        #mistakes1, #mistakes2 {
            text-align: left;
            margin-top: 25px;
            font-size: 1.4em;
        }
        #mistakes1 .wrong, #mistakes2 .wrong {
            color: var(--red);
        }
        #mistakes1 .correct, #mistakes2 .correct {
            color: var(--green);
        }
        #leaderboard1, #leaderboard2 {
            margin-top: 20px;
            display: none;
        }
        #leaderboard1 ol, #leaderboard2 ol {
            padding-left: 20px;
            margin: 8px 0;
            list-style-type: none;
        }
        #leaderboard1 li, #leaderboard2 li {
            color: var(--blue);
            padding: 5px;
        }
        #leaderboard1 li.me, #leaderboard2 li.me {
            color: var(--red);
            font-weight: bold;
            background-color: #ffe4e1;
            border-radius: 4px;
        }
        #game2 div:nth-child(4) {
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .question {
                font-size: 2.4em;
                margin: 15px 0;
            }
            .question span {
                min-width: 35px;
            }
            input[type="number"] {
                font-size: 1.8em;
                width: 100px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .container {
                padding: 20px 15px;
            }
            button {
                padding: 12px 24px;
                font-size: 1.1em;
                margin: 8px;
            }
            #mistakeBtn1, #leaderBtn1, #mistakeBtn2, #leaderBtn2, #pauseBtn1, #pauseBtn2 {
                margin: 8px;
            }
            #score2, #bestTime2 {
                font-size: 1.2em;
            }
        }
        /* Initially hide game divs until mode is selected by JS */
        #game1, #game2 {
             display: none;
        }
    </style>
</head>
<body>
    <div style="text-align: right; margin-bottom: 10px">
        🔊 <button id="soundToggle"><span id="soundToggle_en">Sound: On</span><span id="soundToggle_zh" style="display:none;">音效: 開</span></button> &nbsp;
        🌐 <span id="langLabel_en">Language:</span><span id="langLabel_zh" style="display:none;">語言:</span>
        <select id="langSelect" style="font-size: 1em" aria-label="Select language">
            <option value="en">English</option>
            <option value="zh">繁體中文</option>
        </select>
    </div>

    <div id="game1" class="container">
        <h1><span id="title1_en">Super Speedy Sums Splash!</span><span id="title1_zh" style="display:none;">超級快速加法遊戲！</span></h1>
        <p><span id="helpText1_en">What is the unit digit of the result?</span><span id="helpText1_zh" style="display:none;">請找出答案的個位數字是多少？</span></p>
        <div class="question" aria-live="polite">
            <span id="num1_1"></span> + <span id="num2_1"></span> = <span id="answerField1">?</span>
        </div>
        <input type="number" id="answerInput1" min="0" max="9" autocomplete="off" />
        <div id="feedback1" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score1"><span id="scoreText1_en">Score: </span><span id="scoreText1_zh" style="display:none;">得分: </span>0</span>  
            <span style="color:red">•</span>  
            <span id="highScore1"><span id="highScoreText1_en">High Score: </span><span id="highScoreText1_zh" style="display:none;">最高分: </span>0</span>
        </div>
        <div id="timer1"><span id="timerText1_en">Time Left: </span><span id="timerText1_zh" style="display:none;">剩餘時間：</span>60s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn1" style="background: #ff6347; color: white; margin: 0 4px;">⏸️ <span id="pauseBtn1_en">Pause</span><span id="pauseBtn1_zh" style="display:none;">暫停</span></button>
            <button id="mistakeBtn1"><span id="mistakeBtn1_en">❌ Mistakes</span><span id="mistakeBtn1_zh" style="display:none;">❌ 錯題</span></button>
            <button id="leaderBtn1"><span id="leaderBtn1_en">📊 Leaderboard</span><span id="leaderBtn1_zh" style="display:none;">📊 排行榜</span></button>
        </div>
        <div id="mistakes1" style="display:none;"></div>
        <div id="leaderboard1">
            <h3><span id="leaderTitle1_en">🏆 Top 5 Scores</span><span id="leaderTitle1_zh" style="display:none;">🏆 前 5 名得分</span></h3>
            <ol id="leaderList1"></ol>
            <p id="noLeaderData1" style="display:none;color:var(--blue);"><span id="noLeaderData1_en">No leaderboard data available.</span><span id="noLeaderData1_zh" style="display:none;">暫無排行榜數據。</span></p>
        </div>
        <button id="restartBtn1"><span id="restartBtn1_en">Play Again</span><span id="restartBtn1_zh" style="display:none;">再玩一次</span></button>
        <div id="pauseOverlay1" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText1_en">Paused</span><span id="pausedText1_zh" style="display:none;">已暫停</span><br>
            <button id="resumeBtn1">▶️ <span id="resumeBtn1_en">Resume</span><span id="resumeBtn1_zh" style="display:none;">繼續</span></button>
        </div>
    </div>

    <div id="game2" class="container">
        <h1><span id="title2_en">One Hundred Rush</span><span id="title2_zh" style="display:none;">最快一百分</span></h1>
        <p><span id="subtitle2_en">Answer until you hit <strong>100 points</strong>. How fast can you get there?</span><span id="subtitle2_zh" style="display:none;">持續答題直到達到 <strong>100 分</strong>。你能多快完成？</span></p>
        <div class="question" aria-live="polite">
            <span id="num1_2"></span> + <span id="num2_2"></span> = <span id="answerField2">?</span>
        </div>
        <input type="number" id="answerInput2" min="0" max="9" autocomplete="off" />
        <div id="feedback2" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score2"><span id="scoreText2_en">Score: </span><span id="scoreText2_zh" style="display:none;">得分: </span>0</span>  
            <span style="color:red">•</span>  
            <span id="bestTime2"><span id="bestTimeText2_en">Best Time: </span><span id="bestTimeText2_zh" style="display:none;">最佳時間: </span>–</span>
        </div>
        <div style="margin: 10px auto; width: 80%; background: #ddd; border-radius: 5px;">
            <div id="progressBar2" style="width: 0%; height: 10px; background: var(--green); border-radius: 5px;"></div>
        </div>
        <div id="timeUsed2"><span id="timeUsedText2_en">Time Used: </span><span id="timeUsedText2_zh" style="display:none;">已用時間: </span>0.0 s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn2" style="background: #ff6347; color: white; margin: 0 4px;">⏸️ <span id="pauseBtn2_en">Pause</span><span id="pauseBtn2_zh" style="display:none;">暫停</span></button>
            <button id="mistakeBtn2"><span id="mistakeBtn2_en">❌ Mistakes</span><span id="mistakeBtn2_zh" style="display:none;">❌ 錯題</span></button>
            <button id="leaderBtn2"><span id="leaderBtn2_en">📊 Leaderboard</span><span id="leaderBtn2_zh" style="display:none;">📊 排行榜</span></button>
        </div>
        <div id="mistakes2" style="display:none;"></div>
        <div id="leaderboard2">
            <h3><span id="leaderTitle2_en">🏆 Top 5 Fastest</span><span id="leaderTitle2_zh" style="display:none;">🏆 前 5 名最快</span></h3>
            <ol id="leaderList2"></ol>
            <p id="noLeaderData2" style="display:none;color:var(--blue);"><span id="noLeaderData2_en">No leaderboard data available.</span><span id="noLeaderData2_zh" style="display:none;">暫無排行榜數據。</span></p>
        </div>
        <button id="restartBtn2"><span id="restartBtn2_en">Play Again</span><span id="restartBtn2_zh" style="display:none;">再玩一次</span></button>
        <div id="pauseOverlay2" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText2_en">Paused</span><span id="pausedText2_zh" style="display:none;">已暫停</span><br>
            <button id="resumeBtn2">▶️ <span id="resumeBtn2_en">Resume</span><span id="resumeBtn2_zh" style="display:none;">繼續</span></button>
        </div>
    </div>

    <script>
         // Shared Setup
        // Initialize username immediately
        const username = (() => {
            let n = localStorage.getItem("username");
            if (!n) {
                // Use default language 'en' if langSelect is not available yet, to avoid error
                const lang = document.querySelector("#langSelect") ? document.querySelector("#langSelect").value : 'en';
                n = prompt(lang === "en" ? "Your name?" : "請輸入你的名字：") || "Anonymous";
                localStorage.setItem("username", n);
            }
            return n;
        })();


        firebase.initializeApp({
            apiKey: "AIzaSyB-qOLia1TQAeK3U_HrJZJ7M4ePlJkS2Ik",
            authDomain: "speedsums-621b2.firebaseapp.com",
            projectId: "speedsums-621b2",
            storageBucket: "speedsums-621b2.appspot.com",
            messagingSenderId: "812641533469",
            appId: "1:812641533469:web:c3fe978e04f48cb3bf50f4"
        });
        const db = firebase.database();

        const q = s => document.querySelector(s);

        // Sound Toggle
        let soundEnabled = true;
        const soundToggleBtn = q("#soundToggle");
        if (soundToggleBtn) {
            soundToggleBtn.addEventListener("click", () => {
                soundEnabled = !soundEnabled;
                const lang = q("#langSelect") ? q("#langSelect").value : 'en';
                soundToggleBtn.innerHTML = lang === "en" ?
                    `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none;">音效: ${soundEnabled ? "開" : "關"}</span>` :
                    `<span id="soundToggle_en" style="display:none;">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">音效: ${soundEnabled ? "開" : "關"}</span>`;
            });
        }


        function playRandomCorrectSound() {
            if (!soundEnabled) return;
            const correctSounds = [
                q("#okaySound"),
                q("#welldoneSound"),
                q("#correctSound"),
                q("#greatSound"),
                q("#c1Sound"),
                q("#c2Sound"),
                q("#c3Sound"),
                q("#c4Sound"),
                q("#c5Sound"),
                q("#c6Sound")
            ];
            const randomSound = correctSounds[Math.floor(Math.random() * correctSounds.length)];
             if (randomSound) {
                 try { randomSound.currentTime = 0; randomSound.play(); } catch(e) { console.error("Sound playback error:", e); }
             }
        }

        // Language Persistence
        const langSelect = q("#langSelect");
        const savedLang = localStorage.getItem("lang") || "en";
        if (langSelect) {
             langSelect.value = savedLang;
        }


        function switchLang() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            document.querySelectorAll("[id$='_en']").forEach(el => el.style.display = lang === "en" ? "inline" : "none");
            document.querySelectorAll("[id$='_zh']").forEach(el => el.style.display = lang === "zh" ? "inline" : "none");

            // Update specific elements that need language adjustments for Game 1
            updateScore1();
            updateHighScore1();
            updateTimer1();
            if (q("#mistakes1") && q("#mistakes1").style.display === "block") showMistakes1();
            // No leaderboard refresh here, only on game end or button click
            // if (q("#leaderboard1") && q("#leaderboard1").style.display === "block") refreshLeaderboard1();


            // Update specific elements that need language adjustments for Game 2
            updateScore2();
            updateTimer2(); // Update time used display format
            const bestEl2 = q("#bestTime2");
             if(bestEl2) {
                 bestEl2.innerHTML = `<span id="bestTimeText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">最佳時間: </span>${bestTime2 ? bestTime2.toFixed(1) + ' s' : '–'}`;
            }

            if (q("#mistakes2") && q("#mistakes2").style.display === "block") showMistakes2();
            // No leaderboard refresh here, only on game end or button click
            // if (q("#leaderboard2") && q("#leaderboard2").style.display === "block") refreshLeaderboard2();

            // Update sound toggle text
            const soundToggleBtn = q("#soundToggle");
            if (soundToggleBtn) {
                soundToggleBtn.innerHTML = lang === "en" ?
                    `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none;">音效: ${soundEnabled ? "開" : "關"}</span>` :
                    `<span id="soundToggle_en" style="display:none;">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">音效: ${soundEnabled ? "開" : "關"}</span>`;
            }
        }

        if (langSelect) {
             langSelect.addEventListener("change", () => {
                 localStorage.setItem("lang", langSelect.value);
                 switchLang();
             });
        }

        // --- Game 1 Variables and Functions ---
        let score1 = 0, timeLeft1 = 60, highScore1 = parseInt(localStorage.getItem("highScore1") || 0), timer1, mistakes1 = [], num1_1, num2_1, myLastScore1 = null;
        let isPaused1 = false;
        const num1El1 = q("#num1_1"), num2El1 = q("#num2_1"), ansInp1 = q("#answerInput1"), ansFld1 = q("#answerField1"),
              scoreEl1 = q("#score1"), timerEl1 = q("#timer1"), highScoreEl1 = q("#highScore1"), fbk1 = q("#feedback1"),
              mistakesDiv1 = q("#mistakes1"), leaderDiv1 = q("#leaderboard1"), leaderList1 = q("#leaderList1"), noLeaderData1 = q("#noLeaderData1");

        function updateScore1() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            if (scoreEl1) {
                 scoreEl1.innerHTML = `<span id="scoreText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">得分: </span>${score1}`;
            }
        }

        function updateHighScore1() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            if (highScoreEl1) {
                 highScoreEl1.innerHTML = `<span id="highScoreText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">High Score: </span><span id="highScoreText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">最高分: </span>${highScore1}`;
            }
        }

        function updateTimer1() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            if (timerEl1) {
                 timerEl1.innerHTML = `<span id="timerText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Left: </span><span id="timerText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">剩餘時間：</span>${timeLeft1}s`;
            }
        }

        function generateQuestion1() {
            num1_1 = Math.floor(Math.random() * 9) + 1;
            num2_1 = Math.floor(Math.random() * 9) + 1;
            if (num1El1) num1El1.textContent = num1_1;
            if (num2El1) num2El1.textContent = num2_1;
            if (ansInp1) { ansInp1.value = ""; ansInp1.focus(); }
            if (fbk1) fbk1.textContent = "";
            if (ansFld1) ansFld1.textContent = "?";
        }

        function checkAnswer1(userAnswer) {
            const correctAnswer = (num1_1 + num2_1) % 10;
            if (ansFld1) {
                if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                    const correctEmojis = ['🐟', '✨', '🎉'];
                    const randomCorrect = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                    ansFld1.innerHTML = userAnswer + ' <span class="correct">✔' + randomCorrect + '</span>';
                    score1 += 2;
                    updateScore1();
                    playRandomCorrectSound();
                } else {
                    const wrongEmojis = ['😵', '💦'];
                    const randomWrong = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
                    ansFld1.innerHTML = userAnswer + ' <span class="incorrect">✘' + randomWrong + '</span>';
                    mistakes1.push({
                        question: `${num1_1} + ${num2_1}`,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer
                    });
                    score1 = Math.max(0, score1 - 1);
                    updateScore1();
                }
            }
            setTimeout(generateQuestion1, 500);
        }

        function showMistakes1() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            if (!mistakesDiv1 || !leaderDiv1) return;
            mistakesDiv1.innerHTML = `<h3><span id="mistakesTitle1_en" style="display:${lang === 'en' ? 'block' : 'none'}">❌ Mistakes</span><span id="mistakesTitle1_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">❌ 錯題</span></h3>`;
            if (mistakes1.length === 0) {
                mistakesDiv1.innerHTML += `<p><span id="noMistakes1_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! 🎉</span><span id="noMistakes1_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">沒有錯誤！🎉</span></p>`;
            } else {
                mistakes1.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.question} = <span class="wrong">${m.userAnswer}</span>, <span class="correct">${m.correctAnswer}</span>`;
                    mistakesDiv1.appendChild(div);
                });
            }
            mistakesDiv1.style.display = "block";
            leaderDiv1.style.display = "none";
        }

        function refreshLeaderboard1() {
             if (!leaderDiv1 || !leaderList1 || !noLeaderData1) return;
            db.ref("scores").orderByChild("score").limitToLast(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.score === "number" && !isNaN(val.score) && val.timestamp) {
                         arr.push({ name: val.name, score: val.score, timestamp: val.timestamp });
                    }
                });

                 const virtualData1 = [
                    { name: "Alex", score: 60, timestamp: Date.now() - 1000 },
                    { name: "明", score: 52, timestamp: Date.now() - 2000 },
                    { name: "Kitty Chow", score: 45, timestamp: Date.now() - 3000 },
                    { name: "Tommy Lee", score: 38, timestamp: Date.now() - 4000 },
                    { name: "呀寶", score: 30, timestamp: Date.now() - 5000 }
                ];

                 let combinedArr = [...arr];
                 if (myLastScore1 !== null) {
                     const userEntry = combinedArr.find(entry => entry.name === username && entry.score === myLastScore1);
                     if (!userEntry) {
                         combinedArr.push({ name: username, score: myLastScore1, timestamp: Date.now() });
                     }
                 }

                 combinedArr.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);

                 const top5Map = new Map();
                 for(const entry of combinedArr) {
                      const key = `${entry.name}-${entry.score}`;
                      if (!top5Map.has(key)) {
                           top5Map.set(key, entry);
                      }
                      if (top5Map.size >= 5) break;
                 }
                 const top5Arr = Array.from(top5Map.values());


                 const currentTopCount = top5Arr.length;
                 if (currentTopCount < 5) {
                     const virtualToAdd = virtualData1.filter(vEntry =>
                         !top5Arr.some(rEntry => rEntry.name === vEntry.name && rEntry.score === vEntry.score)
                     ).slice(0, 5 - currentTopCount);
                     top5Arr.push(...virtualToAdd);
                      top5Arr.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);
                 }


                if (top5Arr.length === 0) {
                     if(leaderList1) leaderList1.innerHTML = "";
                     if(noLeaderData1) noLeaderData1.style.display = "block";
                } else {
                     if(leaderList1) leaderList1.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < top5Arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (top5Arr[i].score === top5Arr[i - 1].score) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }
                    top5Arr.slice(0, 5).forEach((entry, i) => {
                         if(leaderList1) {
                            const li = document.createElement("li");
                            const medal = i === 0 ? "🥇" : i === 1 ? "🥈" : i === 2 ? "🥉" : "";
                            li.textContent = `${ranks[i]}. ${entry.name} – ${entry.score} ${medal}`;
                            if (entry.name === username && entry.score === myLastScore1 && myLastScore1 !== null) {
                                li.classList.add("me");
                            }
                            leaderList1.appendChild(li);
                         }
                    });
                     noLeaderData1.style.display = "none";
                }
                 if (leaderDiv1) leaderDivDiv1.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                 if(leaderList1) leaderList1.innerHTML = "";
                 if(noLeaderData1) noLeaderData1.style.display = "block";
            });
        }


        function startTimer1() {
             if (!timerEl1) return;
            timer1 = setInterval(() => {
                if (isPaused1) return;
                timeLeft1--;
                updateTimer1();
                if (timeLeft1 === 5 && soundEnabled) {
                     try { q("#countdownSound").currentTime = 0; q("#countdownSound").play(); } catch(e) { console.error("Sound playback error:", e); }
                }
                if (timeLeft1 <= 0) {
                    clearInterval(timer1);
                    const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
                    if (fbk1) fbk1.textContent = lang === "en" ? "Time's up! 🕒" : "時間到！🕒";
                    if (ansInp1) ansInp1.disabled = true;
                    myLastScore1 = score1;
                    db.ref("scores").push({ name: username, score: score1, timestamp: Date.now() }).then(() => {
                        refreshLeaderboard1();
                        if (score1 > highScore1) {
                            highScore1 = score1;
                            localStorage.setItem("highScore1", highScore1);
                            updateHighScore1();
                            if (soundEnabled) { try { q("#cheerSound").currentTime = 0; q("#cheerSound").play(); } catch(e) { console.error("Cheer sound error:", e); } }
                        }
                        if (q("#restartBtn1")) q("#restartBtn1").style.display = "inline-block";
                         if (mistakes1.length > 0) {
                              showMistakes1();
                         } else {
                              refreshLeaderboard1();
                         }
                    }).catch(error => {
                        console.error("Error saving score:", error);
                        if (fbk1) fbk1.textContent = lang === "en" ? "Error saving to leaderboard." : "無法保存到排行榜。";
                        if (q("#restartBtn1")) q("#restartBtn1").style.display = "inline-block";
                         if (mistakes1.length > 0) {
                              showMistakes1();
                         }
                    });
                }
            }, 1000);
        }


        function startGame1() {
            score1 = 0;
            timeLeft1 = 60;
            mistakes1 = [];
            myLastScore1 = null;
            isPaused1 = false;
             clearInterval(timer1);
            updateScore1();
            updateTimer1();
             if(mistakesDiv1) mistakesDiv1.style.display = "none";
             if(leaderDiv1) leaderDiv1.style.display = "none";
             if(leaderList1) leaderList1.innerHTML = "";
             if(noLeaderData1) noLeaderData1.style.display = "none";
             if(q("#restartBtn1")) q("#restartBtn1").style.display = "none";
             if(q("#pauseOverlay1")) q("#pauseOverlay1").style.display = "none";
            if (ansInp1) ansInp1.disabled = false;
            if (fbk1) fbk1.textContent = "";
            generateQuestion1();
            startTimer1();
             if (ansInp1) ansInp1.focus();
        }

        if (ansInp1) {
             ansInp1.addEventListener("input", e => {
                if (e.target.value.length > 1) {
                    e.target.value = e.target.value.slice(0, 1);
                }
                const val = parseInt(e.target.value, 10);
                 if (!isNaN(val)) {
                     checkAnswer1(val);
                }
            });
             ansInp1.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const val = parseInt(ansInp1.value, 10);
                     if (!isNaN(val)) {
                          checkAnswer1(val);
                     }
                     e.preventDefault();
                }
             });
        }

        if (q("#mistakeBtn1")) {
             q("#mistakeBtn1").addEventListener("click", () => {
                if (mistakesDiv1 && leaderDiv1) {
                    if (mistakesDiv1.style.display === "block") {
                        mistakesDiv1.style.display = "none";
                    } else {
                        showMistakes1();
                        leaderDiv1.style.display = "none";
                    }
                }
            });
        }

        if (q("#leaderBtn1")) {
            q("#leaderBtn1").addEventListener("click", () => {
                if (leaderDiv1 && mistakesDiv1 && noLeaderData1) {
                    if (leaderDiv1.style.display === "block") {
                        leaderDiv1.style.display = "none";
                        noLeaderData1.style.display = "none";
                    } else {
                        refreshLeaderboard1();
                        mistakesDiv1.style.display = "none";
                    }
                }
            });
        }

        if (q("#pauseBtn1")) {
            q("#pauseBtn1").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay1");
                 if (pauseOverlay && ansInp1) {
                    isPaused1 = true;
                    clearInterval(timer1);
                    pauseOverlay.style.display = "block";
                    ansInp1.disabled = true;
                 }
            });
        }

        if (q("#resumeBtn1")) {
            q("#resumeBtn1").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay1");
                 if (pauseOverlay && ansInp1) {
                    isPaused1 = false;
                    pauseOverlay.style.display = "none";
                    startTimer1();
                    ansInp1.disabled = false;
                    ansInp1.focus();
                 }
            });
        }

        if (q("#restartBtn1")) {
            q("#restartBtn1").addEventListener("click", () => {
                 window.location.href = 'index.html';
            });
        }


        // --- Game 2 Variables and Functions ---
        const TARGET_SCORE2 = 100, CORRECT_POINTS2 = 2, WRONG_POINTS2 = -1;
        let score2 = 0, startTime2, timerInterval2, bestTime2 = parseFloat(localStorage.getItem("bestTime2") || null), mistakes2 = [], num1_2, num2_2, myLastTime2 = null;
        let isPaused2 = false, gameStarted2 = false;
        const num1El2 = q("#num1_2"), num2El2 = q("#num2_2"), ansInp2 = q("#answerInput2"), ansFld2 = q("#answerField2"),
              scoreEl2 = q("#score2"), timeUsedEl2 = q("#timeUsed2"), bestEl2 = q("#bestTime2"), fbk2 = q("#feedback2"),
              progressBar2 = q("#progressBar2"), mistakesDiv2 = q("#mistakes2"), leaderDiv2 = q("#leaderboard2"), leaderList2 = q("#leaderList2"), noLeaderData2 = q("#noLeaderData2");

        function updateScore2() {
             if (!scoreEl2 || !progressBar2) return;
            score2 = Math.max(0, score2);
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            scoreEl2.innerHTML = `<span id="scoreText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">得分: </span>${score2}`;
            progressBar2.style.width = `${Math.min(100, (score2 / TARGET_SCORE2) * 100)}%`;
            progressBar2.style.backgroundColor = score2 >= TARGET_SCORE2 ? 'var(--green)' : 'var(--orange)';
        }

        function updateTimer2() {
             if (!timeUsedEl2 || !gameStarted2) return;
             const elapsed = isPaused2 ? timeUsed2 : (Date.now() - (startTime2 - timeUsed2 * 1000)) / 1000;
             timeUsed2 = elapsed;
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            timeUsedEl2.innerHTML = `<span id="timeUsedText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Used: </span><span id="timeUsedText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">已用時間: </span>${timeUsed2.toFixed(1)} s`;
        }

        function generateQuestion2() {
            num1_2 = Math.floor(Math.random() * 9) + 1;
            num2_2 = Math.floor(Math.random() * 9) + 1;
            if (num1El2) num1El2.textContent = num1_2;
            if (num2El2) num2El2.textContent = num2_2;
             if (ansInp2) { ansInp2.value = ""; ansInp2.focus(); }
             if (fbk2) fbk2.textContent = "";
             if (ansFld2) ansFld2.textContent = "?";
        }

        function checkAnswer2(v) {
             if (!ansFld2) return;
            const correct = (num1_2 + num2_2) % 10;
            if (!isNaN(v) && v === correct) {
                ansFld2.innerHTML = `${v} <span class="correct">✔</span>`;
                score2 += CORRECT_POINTS2;
                updateScore2();
                playRandomCorrectSound();
            } else {
                ansFld2.innerHTML = `${v} <span class="incorrect">✘</span>`;
                score2 += WRONG_POINTS2;
                updateScore2();
                mistakes2.push({ q: `${num1_2}+${num2_2}`, user: v, correct });
            }
            if (score2 >= TARGET_SCORE2) {
                finishGame2();
            } else {
                setTimeout(generateQuestion2, 400);
            }
        }

        function showMistakes2() {
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if (!mistakesDiv2 || !leaderDiv2) return;
            mistakesDiv2.innerHTML = `<h3><span id="mistakesTitle2_en" style="display:${lang === 'en' ? 'block' : 'none'}">❌ Mistakes</span><span id="mistakesTitle2_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">❌ 錯題</span></h3>`;
            if (mistakes2.length === 0) {
                mistakesDiv2.innerHTML += `<p><span id="noMistakes2_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! 🎉</span><span id="noMistakes2_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">沒有錯誤！🎉</span></p>`;
            } else {
                mistakes2.forEach(m => {
                    const d = document.createElement("div");
                    d.innerHTML = `${m.q} = <span class="wrong">${m.user}</span>, <span class="correct">${m.correct}</span>`;
                    mistakesDiv2.appendChild(d);
                });
            }
            mistakesDiv2.style.display = "block";
            leaderDiv2.style.display = "none";
        }

        function refreshLeaderboard2() {
             if (!leaderDiv2 || !leaderList2 || !noLeaderData2) return;
            db.ref("times").orderByChild("time").limitToFirst(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.time === "number" && !isNaN(val.time) && val.ts) {
                         arr.push({ name: val.name, time: val.time, ts: val.ts });
                    }
                });

                 const virtualData2 = [
                    { name: "Snoopy", time: 78, ts: Date.now() - 1000 },
                    { name: "小美", time: 84, ts: Date.now() - 2000 },
                    { name: "張玲麗", time: 92, ts: Date.now() - 3000 },
                    { name: "Richard", time: 99, ts: Date.now() - 4000 },
                    { name: "Tommy Lee", time: 105, ts: Date.now() - 5000 }
                ];
                 let combinedArr = [...arr];
                 if (myLastTime2 !== null) {
                      const userEntry = combinedArr.find(entry => entry.name === username && entry.time === myLastTime2);
                       if (!userEntry) {
                           combinedArr.push({ name: username, time: myLastTime2, ts: Date.now() });
                       }
                 }

                 combinedArr.sort((a, b) => a.time - b.time || a.ts - b.ts);

                 const top5Map = new Map();
                 for(const entry of combinedArr) {
                      const key = `${entry.name}-${entry.time}`;
                      if (!top5Map.has(key)) {
                           top5Map.set(key, entry);
                      }
                      if (top5Map.size >= 5) break;
                 }
                 const top5Arr = Array.from(top5Map.values());


                 const currentTopCount = top5Arr.length;
                 if (currentTopCount < 5) {
                     const virtualToAdd = virtualData2.filter(vEntry =>
                         !top5Arr.some(rEntry => rEntry.name === vEntry.name && rEntry.time === vEntry.time)
                     ).slice(0, 5 - currentTopCount);
                     top5Arr.push(...virtualToAdd);
                      top5Arr.sort((a, b) => a.time - b.time || a.ts - b.ts);
                 }


                if (top5Arr.length === 0) {
                    leaderList2.innerHTML = "";
                    noLeaderData2.style.display = "block";
                } else {
                     leaderList2.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < top5Arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (top5Arr[i].time === top5Arr[i - 1].time) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }
                    top5Arr.slice(0, 5).forEach((item, i) => {
                        if(leaderList2) {
                            const li = document.createElement("li");
                            const medal = i === 0 ? "🥇" : i === 1 ? "🥈" : i === 2 ? "🥉" : "";
                            li.textContent = `${ranks[i]}. ${item.name} – ${item.time.toFixed(1)} s ${medal}`;
                            if (item.name === username && item.time === myLastTime2 && myLastTime2 !== null) {
                                li.classList.add("me");
                            }
                            leaderList2.appendChild(li);
                         }
                    });
                    noLeaderData2.style.display = "none";
                }
                 if (leaderDiv2) leaderDiv2.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                 if(leaderList2) leaderList2.innerHTML = "";
                 if(noLeaderData2) noLeaderData2.style.display = "block";
            });
        }


        function finishGame2() {
             if (!timeUsed2 || !fbk2 || !ansInp2 || !q("#restartBtn2")) return;
            clearInterval(timerInterval2);
            ansInp2.disabled = true;
            const tSec = timeUsed2.toFixed(1);
            myLastTime2 = parseFloat(tSec);
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
            fbk2.innerHTML = `<span style="color:var(--orange);font-size:1.4em">${lang === 'en' ? 'Finished in' : '完成時間'}: ${tSec} s</span>`;
            q("#restartBtn2").style.display = "inline-block";
            if (!bestTime2 || myLastTime2 < bestTime2) {
                bestTime2 = myLastTime2;
                localStorage.setItem("bestTime2", bestTime2);
                 if(bestEl2) {
                     bestEl2.innerHTML = `<span id="bestTimeText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">最佳時間: </span>${bestTime2.toFixed(1)} s`;
                 }
                if (soundEnabled) { try { q("#cheerSound").currentTime = 0; q("#cheerSound").play(); } catch(e) { console.error("Cheer sound error:", e); } }
            }
            db.ref("times").push({ name: username, time: parseFloat(tSec), ts: Date.now() }).then(() => {
                refreshLeaderboard2();
                 if (mistakes2.length > 0) {
                      showMistakes2();
                 } else {
                      refreshLeaderboard2();
                 }
            }).catch(error => {
                console.error("Error saving time:", error);
                fbk2.innerHTML += `<br><span style="color:var(--red)">${lang === 'en' ? 'Error saving to leaderboard.' : '無法保存到排行榜。'}</span>`;
                 if (mistakes2.length > 0) {
                      showMistakes2();
                 }
            });
        }


        function startGame2() {
            score2 = 0;
            timeUsed2 = 0;
            mistakes2 = [];
            myLastTime2 = null;
            isPaused2 = false;
            gameStarted2 = true;
            updateScore2();
            updateTimer2();
             if(mistakesDiv2) mistakesDiv2.style.display = "none";
             if(leaderDiv2) leaderDiv2.style.display = "none";
             if(leaderList2) leaderList2.innerHTML = "";
             if(noLeaderData2) noLeaderData2.style.display = "none";
             if(q("#restartBtn2")) q("#restartBtn2").style.display = "none";
             if(q("#pauseOverlay2")) q("#pauseOverlay2").style.display = "none";
            if (ansInp2) ansInp2.disabled = false;
            if (fbk2) fbk2.textContent = "";
            const lang = q("#langSelect") ? q("#langSelect").value : savedLang;
             if(bestEl2) {
                bestEl2.innerHTML = `<span id="bestTimeText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">最佳時間: </span>${bestTime2 ? bestTime2.toFixed(1) + ' s' : '–'}`;
             }
            startTime2 = Date.now();
            clearInterval(timerInterval2);
             timerInterval2 = setInterval(() => {
                if (!isPaused2) updateTimer2();
            }, 100);
            generateQuestion2();
             if (ansInp2) ansInp2.focus();
        }


        if (ansInp2) {
            ansInp2.addEventListener("input", e => {
                if (e.target.value.length > 1) {
                    e.target.value = e.target.value.slice(0, 1);
                }
                const v = parseInt(e.target.value, 10);
                 if (!isNaN(v)) {
                      checkAnswer2(v);
                 }
            });
             ansInp2.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const v = parseInt(ansInp2.value, 10);
                     if (!isNaN(v)) {
                          checkAnswer2(v);
                     }
                     e.preventDefault();
                }
             });
        }

        if (q("#mistakeBtn2")) {
            q("#mistakeBtn2").addEventListener("click", () => {
                if (mistakesDiv2 && leaderDiv2) {
                    if (mistakesDiv2.style.display === "block") {
                        mistakesDiv2.style.display = "none";
                    } else {
                        showMistakes2();
                        leaderDiv2.style.display = "none";
                    }
                }
            });
        }

        if (q("#leaderBtn2")) {
             q("#leaderBtn2").addEventListener("click", () => {
                if (leaderDiv2 && mistakesDiv2 && noLeaderData2) {
                    if (leaderDiv2.style.display === "block") {
                        leaderDiv2.style.display = "none";
                        noLeaderData2.style.display = "none";
                    } else {
                        refreshLeaderboard2();
                        mistakesDiv2.style.display = "none";
                    }
                }
            });
        }

        if (q("#pauseBtn2")) {
            q("#pauseBtn2").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay2");
                 if (pauseOverlay && ansInp2) {
                    isPaused2 = true;
                    clearInterval(timerInterval2);
                    pauseOverlay.style.display = "block";
                    ansInp2.disabled = true;
                 }
            });
        }

        if (q("#resumeBtn2")) {
            q("#resumeBtn2").addEventListener("click", () => {
                 const pauseOverlay = q("#pauseOverlay2");
                 if (pauseOverlay && ansInp2) {
                    isPaused2 = false;
                    pauseOverlay.style.display = "none";
                    startTime2 = Date.now() - timeUsed2 * 1000;
                    timerInterval2 = setInterval(() => {
                        if (!isPaused2) updateTimer2();
                    }, 100);
                    ansInp2.disabled = false;
                    ansInp2.focus();
                 }
            });
        }

        if (q("#restartBtn2")) {
            q("#restartBtn2").addEventListener("click", () => {
                 window.location.href = 'index.html';
            });
        }

        // --- Initialisation based on URL Hash ---
        // Find the game divs
        const game1Div = q("#game1");
        const game2Div = q("#game2");

        // Function: Hide all game divs initially
        function hideAllGames() {
            if(game1Div) game1Div.style.display = 'none';
            if(game2Div) game2Div.style.display = 'none';
        }

        // Function: Start game based on mode from URL hash
        function startGameByMode() {
            hideAllGames();

            const hash = window.location.hash;

            if (hash === '#mode=1min') {
                if(game1Div) game1Div.style.display = 'block';
                startGame1();
            } else if (hash === '#mode=100pts') {
                if(game2Div) game2Div.style.display = 'block';
                startGame2();
            } else {
                 console.warn("No valid game mode specified in URL hash. Redirecting to index.html");
                 window.location.href = 'index.html';
            }
            if(game1Div && game1Div.style.display === 'block') {
                const ansInput1 = q("#answerInput1");
                if (ansInput1) ansInput1.focus();
            }
            if(game2Div && game2Div.style.display === 'block') {
                 const ansInput2 = q("#answerInput2");
                 if (ansInput2) ansInput2.focus();
            }
        }

        document.addEventListener('DOMContentLoaded', startGameByMode);

        switchLang();

        hideAllGames();

    </script>
</body>
</html>