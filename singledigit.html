<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Digit Math Game</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#4682b4" />
    <link rel="manifest" href="manifest.json" />
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js").catch(console.error);
            });
        }
    </script>
    <audio id="okaySound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/okay.mp3" type="audio/mp3" /></audio>
    <audio id="welldoneSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/welldone.mp3" type="audio/mp3" /></audio>
    <audio id="correctSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/correct.mp3" type="audio/mp3" /></audio>
    <audio id="greatSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/great.mp3" type="audio/mp3" /></audio>
    <audio id="c1Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c1.mp3" type="audio/mp3" /></audio>
    <audio id="c2Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c2.mp3" type="audio/mp3" /></audio>
    <audio id="c3Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c3.mp3" type="audio/mp3" /></audio>
    <audio id="c4Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c4.mp3" type="audio/mp3" /></audio>
    <audio id="c5Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c5.mp3" type="audio/mp3" /></audio>
    <audio id="c6Sound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/c6.mp3" type="audio/mp3" /></audio>
    <audio id="countdownSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/countdown5sec.mp3" type="audio/mp3" /></audio>
    <audio id="cheerSound" preload="auto"><source src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/cheer.mp3" type="audio/mp3" /></audio>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --blue: #4682b4;
            --green: #32cd32;
            --red: #ff4500;
            --orange: #ff9a00;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f8ff url("https://cdn.pixabay.com/photo/2021/05/20/12/51/fish-6269836_1280.png") no-repeat bottom right / 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: #fff;
            padding: 30px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        h1 {
            color: #ff6347;
            margin: 0 0 15px;
            font-size: 2rem;
        }
        .category-title {
            background-color: #ff69b4;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        .horizontal-question {
            color: var(--blue);
            font-size: 2.4em;
            display: inline-block;
            margin-bottom: 10px;
        }
        .horizontal-question input[type="number"] {
            width: 80px;
            font-size: 1em;
            padding: 5px;
            border: 2px solid var(--green);
            border-radius: 5px;
            margin-left: 10px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        #feedback1, #feedback2 {
            font-size: 1.8em;
            min-height: 1.8em;
            margin-top: 20px;
        }
        .correct {
            color: var(--green);
        }
        .incorrect {
            color: var(--red);
        }
        #score1, #highScore1, #timer1, #score2, #bestTime2, #timeUsed2 {
            font-size: 1.6em;
            color: var(--blue);
        }
        #timer1, #timeUsed2 {
            font-size: 1.9em;
            color: var(--orange);
            margin: 10px 0 0;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1.2em;
            margin: 5px;
        }
        #gameSelectBtn1, #gameSelectBtn2 {
            background: #ffd700;
            white-space: nowrap;
        }
        #mistakeBtn1, #leaderBtn1, #mistakeBtn2, #leaderBtn2 {
            background: #eee;
            margin: 0 4px;
        }
        #pauseBtn1, #pauseBtn2 {
            background: #ff6347;
            color: white;
            margin: 0 4px;
        }
        #resumeBtn1, #resumeBtn2 {
            background: #32cd32;
            color: white;
            margin-top: 20px;
        }
        #restartBtn1, #restartBtn2, #returnBtn1, #returnBtn2 {
            background: #ffd700;
            padding: 10px 24px;
            font-size: 1.2em;
            margin-top: 25px;
            display: none;
        }
        #soundToggle {
            background: #87ceeb;
            padding: 5px 10px;
            font-size: 1em;
        }
        select {
            padding: 5px;
            font-size: 1em;
            border-radius: 5px;
            margin: 5px;
        }
        #mistakes1, #mistakes2 {
            text-align: left;
            margin-top: 25px;
            font-size: 1.4em;
        }
        #mistakes1 .wrong, #mistakes2 .wrong {
            color: var(--red);
        }
        #mistakes1 .correct, #mistakes2 .correct {
            color: var(--green);
        }
        #leaderboard1, #leaderboard2 {
            margin-top: 20px;
            display: none;
        }
        #leaderboard1 ol, #leaderboard2 ol {
            padding-left: 20px;
            margin: 8px 0;
            list-style-type: none;
        }
        #leaderboard1 li, #leaderboard2 li {
            color: var(--blue);
            padding: 5px;
        }
        #leaderboard1 li.me, #leaderboard2 li.me {
            color: var(--red);
            font-weight: bold;
            background-color: #ffe4e1;
            border-radius: 4px;
        }
        #game2 div:nth-child(4) {
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .horizontal-question {
                font-size: 1.8em;
            }
            .horizontal-question input[type="number"] {
                font-size: 0.8em;
                width: 60px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .container {
                padding: 20px 15px;
            }
            button {
                padding: 12px 24px;
                font-size: 1.1em;
                margin: 8px;
            }
            #gameSelectBtn1, #gameSelectBtn2 {
                font-size: 1em;
            }
            #mistakeBtn1, #leaderBtn1, #mistakeBtn2, #leaderBtn2, #pauseBtn1, #pauseBtn2 {
                margin: 8px;
            }
            #score2, #bestTime2 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div style="text-align: right; margin-bottom: 10px">
        ğŸ”Š <button id="soundToggle"><span id="soundToggle_en">Sound: On</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: é–‹</span></button>
        <select id="langSelect">
            <option value="en">English</option>
            <option value="zh">ä¸­æ–‡</option>
        </select>
    </div>

    <div id="gameSelection" class="container">
        <h1>
            <span id="selectTitle_en">Chan Sir's Single Digit Math Game</span>
            <span id="selectTitle_zh" style="display:none">é™³sirå€‹ä½æ•¸æ•¸å­¸éŠæˆ²</span>
            <img src="https://raw.githubusercontent.com/watson9999/math-game-audio/main/chansir.png" height="40px" alt="Chan Sir" style="vertical-align: middle; margin-left: 5px;" />
        </h1>
        <div class="category-title">
            <span id="category1_en">Single Digit Addition</span>
            <span id="category1_zh" style="display:none">å€‹ä½æ•¸ç›¸åŠ </span>
        </div>
        <button id="gameSelectBtn1">
            <span id="game1Btn_en">Super Speedy Sums Splash (1 min)</span>
            <span id="game1Btn_zh" style="display:none">è¶…ç´šå¿«é€ŸåŠ æ³•éŠæˆ² (1 åˆ†é˜)</span>
        </button>
        <button id="gameSelectBtn2">
            <span id="game2Btn_en">One Hundred Rush</span>
            <span id="game2Btn_zh" style="display:none">æœ€å¿«ä¸€ç™¾åˆ†</span>
        </button>
    </div>
<div id="game1" class="container" style="display:none;">
        <h1><span id="title1_en">Super Speedy Sums Splash!</span><span id="title1_zh" style="display:none">è¶…ç´šå¿«é€ŸåŠ æ³•éŠæˆ²ï¼</span></h1>
        <div class="horizontal-question" aria-live="polite" id="question1">
            <span id="num1_1"></span> + <span id="num2_1"></span> = 
            <input type="number" id="answerInput1" min="0" max="18" autocomplete="off" />
        </div>
        <div id="feedback1" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score1"><span id="scoreText1_en">Score: </span><span id="scoreText1_zh" style="display:none">å¾—åˆ†: </span>0</span> Â 
            <span style="color:red">â€¢</span> Â 
            <span id="highScore1"><span id="highScoreText1_en">High Score: </span><span id="highScoreText1_zh" style="display:none">æœ€é«˜åˆ†: </span>0</span>
        </div>
        <div id="timer1"><span id="timerText1_en">Time Left: </span><span id="timerText1_zh" style="display:none">å‰©é¤˜æ™‚é–“ï¼š</span>60s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn1">â¸ï¸ <span id="pauseBtn1_en">Pause</span><span id="pauseBtn1_zh" style="display:none">æš«åœ</span></button>
            <button id="mistakeBtn1"><span id="mistakeBtn1_en">âŒ Mistakes</span><span id="mistakeBtn1_zh" style="display:none">âŒ éŒ¯é¡Œ</span></button>
            <button id="leaderBtn1"><span id="leaderBtn1_en">ğŸ“Š Leaderboard</span><span id="leaderBtn1_zh" style="display:none">ğŸ“Š æ’è¡Œæ¦œ</span></button>
        </div>
        <div id="mistakes1" style="display:none;"></div>
        <div id="leaderboard1">
            <h3><span id="leaderTitle1_en">ğŸ† Top 5 Scores</span><span id="leaderTitle1_zh" style="display:none">ğŸ† å‰ 5 åå¾—åˆ†</span></h3>
            <ol id="leaderList1"></ol>
            <p id="noLeaderData1" style="display:none;color:var(--blue);"><span id="noLeaderData1_en">No leaderboard data available.</span><span id="noLeaderData1_zh" style="display:none">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“šã€‚</span></p>
        </div>
        <button id="restartBtn1"><span id="restartBtn1_en">Play Again</span><span id="restartBtn1_zh" style="display:none">å†ç©ä¸€æ¬¡</span></button>
        <button id="returnBtn1"><span id="returnBtn1_en">Return to Menu</span><span id="returnBtn1_zh" style="display:none">è¿”å›ç›®éŒ„</span></button>
        <div id="pauseOverlay1" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText1_en">Paused</span><span id="pausedText1_zh" style="display:none">å·²æš«åœ</span><br>
            <button id="resumeBtn1">â–¶ï¸ <span id="resumeBtn1_en">Resume</span><span id="resumeBtn1_zh" style="display:none">ç¹¼çºŒ</span></button>
        </div>
    </div>

    <div id="game2" class="container" style="display:none;">
        <h1><span id="title2_en">One Hundred Rush</span><span id="title2_zh" style="display:none">æœ€å¿«ä¸€ç™¾åˆ†</span></h1>
        <div class="horizontal-question" aria-live="polite" id="question2">
            <span id="num1_2"></span> + <span id="num2_2"></span> = 
            <input type="number" id="answerInput2" min="0" max="18" autocomplete="off" />
        </div>
        <div id="feedback2" aria-live="polite"></div>
        <div style="margin-top: 10px">
            <span id="score2"><span id="scoreText2_en">Score: </span><span id="scoreText2_zh" style="display:none">å¾—åˆ†: </span>0</span> Â 
            <span style="color:red">â€¢</span> Â 
            <span id="bestTime2"><span id="bestTimeText2_en">Best Time: </span><span id="bestTimeText2_zh" style="display:none">æœ€ä½³æ™‚é–“: </span>â€“</span>
        </div>
        <div style="margin: 10px auto; width: 80%; background: #ddd; border-radius: 5px;">
            <div id="progressBar2" style="width: 0%; height: 10px; background: var(--green); border-radius: 5px;"></div>
        </div>
        <div id="timeUsed2"><span id="timeUsedText2_en">Time Used: </span><span id="timeUsedText2_zh" style="display:none">å·²ç”¨æ™‚é–“: </span>0.0â€¯s</div>
        <div style="margin-top: 18px">
            <button id="pauseBtn2">â¸ï¸ <span id="pauseBtn2_en">Pause</span><span id="pauseBtn2_zh" style="display:none">æš«åœ</span></button>
            <button id="mistakeBtn2"><span id="mistakeBtn2_en">âŒ Mistakes</span><span id="mistakeBtn2_zh" style="display:none">âŒ éŒ¯é¡Œ</span></button>
            <button id="leaderBtn2"><span id="leaderBtn2_en">ğŸ“Š Leaderboard</span><span id="leaderBtn2_zh" style="display:none">ğŸ“Š æ’è¡Œæ¦œ</span></button>
        </div>
        <div id="mistakes2" style="display:none;"></div>
        <div id="leaderboard2">
            <h3><span id="leaderTitle2_en">ğŸ† Top 5 Fastest</span><span id="leaderTitle2_zh" style="display:none">ğŸ† å‰ 5 åæœ€å¿«</span></h3>
            <ol id="leaderList2"></ol>
            <p id="noLeaderData2" style="display:none;color:var(--blue);"><span id="noLeaderData2_en">No leaderboard data available.</span><span id="noLeaderData2_zh" style="display:none">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“šã€‚</span></p>
        </div>
        <button id="restartBtn2"><span id="restartBtn2_en">Play Again</span><span id="restartBtn2_zh" style="display:none">å†ç©ä¸€æ¬¡</span></button>
        <button id="returnBtn2"><span id="returnBtn2_en">Return to Menu</span><span id="returnBtn2_zh" style="display:none">è¿”å›ç›®éŒ„</span></button>
        <div id="pauseOverlay2" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10; text-align:center; color:white; font-size:2em; padding-top:20%;">
            <span id="pausedText2_en">Paused</span><span id="pausedText2_zh" style="display:none">å·²æš«åœ</span><br>
            <button id="resumeBtn2">â–¶ï¸ <span id="resumeBtn2_en">Resume</span><span id="resumeBtn2_zh" style="display:none">ç¹¼çºŒ</span></button>
        </div>
    </div>
<script>
        const username = (() => {
            let n = localStorage.getItem("username");
            if (!n) {
                const lang = document.querySelector("#langSelect").value;
                n = prompt(lang === "en" ? "Your name?" : "è«‹è¼¸å…¥ä½ çš„åå­—ï¼š") || "Anonymous";
                localStorage.setItem("username", n);
            }
            return n;
        })();

        firebase.initializeApp({
            apiKey: "AIzaSyB-qOLia1TQAeK3U_HrJZJ7M4ePlJkS2Ik",
            authDomain: "speedsums-621b2.firebaseapp.com",
            projectId: "speedsums ern
            storageBucket: "speedsums-621b2.appspot.com",
            messagingSenderId: "812641533469",
            appId: "1:812641533469:web:c3fe978e04f48cb3bf50f4"
        });
        const db = firebase.database();

        const q = s => document.querySelector(s);

        let soundEnabled = true;
        q("#soundToggle").addEventListener("click", () => {
            soundEnabled = !soundEnabled;
            const lang = q("#langSelect").value;
            q("#soundToggle").innerHTML = lang === "en" ? 
                `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>` : 
                `<span id="soundToggle_en" style="display:none">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>`;
        });

        function playRandomCorrectSound() {
            if (!soundEnabled) return;
            const correctSounds = [
                q("#okaySound"), q("#welldoneSound"), q("#correctSound"), q("#greatSound"),
                q("#c1Sound"), q("#c2Sound"), q("#c3Sound"), q("#c4Sound"), q("#c5Sound"), q("#c6Sound")
            ];
            const randomSound = correctSounds[Math.floor(Math.random() * correctSounds.length)];
            randomSound.play();
        }

        const langSelect = q("#langSelect");
        const savedLang = localStorage.getItem("lang") || "en";
        langSelect.value = savedLang;

        function switchLang() {
            const lang = q("#langSelect").value;
            document.querySelectorAll("[id$='_en']").forEach(el => el.style.display = lang === "en" ? "inline" : "none");
            document.querySelectorAll("[id$='_zh']").forEach(el => el.style.display = lang === "zh" ? "inline" : "none");
            updateScore1(); updateHighScore1(); updateTimer1();
            if (q("#mistakes1").style.display === "block") showMistakes1();
            if (q("#leaderboard1").style.display === "block") refreshLeaderboard1();
            updateScore2(); updateTimer2();
            bestEl2.innerHTML = `<span id="bestTimeText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Best Time: </span><span id="bestTimeText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€ä½³æ™‚é–“: </span>${bestTime2 ? bestTime2.toFixed(2) + ' s' : 'â€“'}`;
            if (q("#mistakes2").style.display === "block") showMistakes2();
            if (q("#leaderboard2").style.display === "block") refreshLeaderboard2();
            q("#soundToggle").innerHTML = lang === "en" ? 
                `<span id="soundToggle_en">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh" style="display:none">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>` : 
                `<span id="soundToggle_en" style="display:none">Sound: ${soundEnabled ? "On" : "Off"}</span><span id="soundToggle_zh">éŸ³æ•ˆ: ${soundEnabled ? "é–‹" : "é—œ"}</span>`;
        }

        langSelect.addEventListener("change", () => {
            localStorage.setItem("lang", langSelect.value);
            switchLang();
        });

        q("#gameSelectBtn1").addEventListener("click", () => {
            q("#gameSelection").style.display = "none";
            q("#game1").style.display = "block";
            q("#game2").style.display = "none";
            startGame1();
        });

        q("#gameSelectBtn2").addEventListener("click", () => {
            q("#gameSelection").style.display = "none";
            q("#game1").style.display = "none";
            q("#game2").style.display = "block";
            startGame2();
        });

        let score1 = 0, timeLeft1 = 60, highScore1 = parseInt(localStorage.getItem("highScore1") || 0), timer1, mistakes1 = [], num1_1, num2_1, myLastScore1 = null;
        let isPaused1 = false;
        const num1El1 = q("#num1_1"), num2El1 = q("#num2_1"), ansInp1 = q("#answerInput1"),
              scoreEl1 = q("#score1"), timerEl1 = q("#timer1"), highScoreEl1 = q("#highScore1"), fbk1 = q("#feedback1"),
              mistakesDiv1 = q("#mistakes1"), leaderDiv1 = q("#leaderboard1"), leaderList1 = q("#leaderList1"), noLeaderData1 = q("#noLeaderData1");

        function updateScore1() {
            const lang = q("#langSelect").value;
            scoreEl1.innerHTML = `<span id="scoreText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å¾—åˆ†: </span>${score1}`;
        }

        function updateHighScore1() {
            const lang = q("#langSelect").value;
            highScoreEl1.innerHTML = `<span id="highScoreText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">High Score: </span><span id="highScoreText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">æœ€é«˜åˆ†: </span>${highScore1}`;
        }

        function updateTimer1() {
            const lang = q("#langSelect").value;
            timerEl1.innerHTML = `<span id="timerText1_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Left: </span><span id="timerText1_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å‰©é¤˜æ™‚é–“ï¼š</span>${timeLeft1}s`;
        }

        function generateQuestion1() {
            num1_1 = Math.floor(Math.random() * 9) + 1;
            num2_1 = Math.floor(Math.random() * 9) + 1;
            num1El1.textContent = num1_1;
            num2El1.textContent = num2_1;
            ansInp1.value = "";
            ansInp1.focus();
            fbk1.textContent = "";
        }

        function checkAnswer1(userAnswer) {
            if (ansInp1.value.length < 1) return;
            const correctAnswer = num1_1 + num2_1;
            if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                const correctEmojis = ['ğŸŸ', 'âœ¨', 'ğŸ‰'];
                const randomCorrect = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                fbk1.innerHTML = userAnswer + ' <span class="correct">âœ”' + randomCorrect + '</span>';
                score1 += 3;
                updateScore1();
                playRandomCorrectSound();
            } else {
                const wrongEmojis = ['ğŸ˜µ', 'ğŸ’¦'];
                const randomWrong = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
                fbk1.innerHTML = userAnswer + ' <span class="incorrect">âœ˜' + randomWrong + '</span>';
                mistakes1.push({
                    question: `${num1_1} + ${num2_1}`,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer
                });
                score1 = Math.max(0, score1 - 1);
                updateScore1();
            }
            setTimeout(generateQuestion1, 500);
        }

        function showMistakes1() {
            const lang = q("#langSelect").value;
            mistakesDiv1.innerHTML = `<h3><span id="mistakesTitle1_en" style="display:${lang === 'en' ? 'block' : 'none'}">âŒ Mistakes</span><span id="mistakesTitle1_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">âŒ éŒ¯é¡Œ</span></h3>`;
            if (mistakes1.length === 0) {
                mistakesDiv1.innerHTML += `<p><span id="noMistakes1_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! ğŸ‰</span><span id="noMistakes1_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">æ²’æœ‰éŒ¯èª¤ï¼ğŸ‰</span></p>`;
            } else {
                mistakes1.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.question} = <span class="wrong">${m.userAnswer}</span>, <span class="correct">${m.correctAnswer}</span>`;
                    mistakesDiv1.appendChild(div);
                });
            }
            mistakesDiv1.style.display = "block";
            leaderDiv1.style.display = "none";
        }

        function refreshLeaderboard1() {
            db.ref("scores").orderByChild("score").limitToLast(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.score === "number" && !isNaN(val.score) && val.timestamp) {
                        arr.push(val);
                    }
                });

                const virtualData1 = [
                    { name: "Alex", score: 60, timestamp: Date.now() - 1000 },
                    { name: "æ˜", score: 52, timestamp: Date.now() - 2000 },
                    { name: "Kitty Chow", score: 45, timestamp: Date.now() - 3000 },
                    { name: "Tommy Lee", score: 38, timestamp: Date.now() - 4000 },
                    { name: "å‘€å¯¶", score: 30, timestamp: Date.now() - 5000 }
                ];
                const neededEntries = 5 - arr.length;
                if (neededEntries > 0) {
                    arr.push(...virtualData1.slice(0, neededEntries));
                }

                arr.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);
                if (arr.length === 0) {
                    leaderList1.innerHTML = "";
                    noLeaderData1.style.display = "block";
                } else {
                    leaderList1.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (arr[i].score === arr[i - 1].score) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }
                    arr.slice(0, 5).forEach((entry, i) => {
                        const li = document.createElement("li");
                        const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "";
                        li.textContent = `${ranks[i]}. ${entry.name} â€“ ${entry.score} ${medal}`;
                        if (entry.name === username && entry.score === myLastScore1) {
                            li.classList.add("me");
                        }
                        leaderList1.appendChild(li);
                    });
                    noLeaderData1.style.display = "none";
                }
                leaderDiv1.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                leaderList1.innerHTML = "";
                noLeaderData1.style.display = "block";
            });
        }

        function startTimer1() {
            timer1 = setInterval(() => {
                if (isPaused1) return;
                timeLeft1--;
                updateTimer1();
                if (timeLeft1 === 5 && soundEnabled) q("#countdownSound").play();
                if (timeLeft1 <= 0) {
                    clearInterval(timer1);
                    const lang = q("#langSelect").value;
                    fbk1.textContent = lang === "en" ? "Time's up! ğŸ•’" : "æ™‚é–“åˆ°ï¼ğŸ•’";
                    ansInp1.disabled = true;
                    myLastScore1 = score1;
                    db.ref("scores").push({ name: username, score: score1, timestamp: Date.now() }).then(() => {
                        refreshLeaderboard1();
                        if (score1 > highScore1) {
                            highScore1 = score1;
                            localStorage.setItem("highScore1", highScore1);
                            updateHighScore1();
                            if (soundEnabled) q("#cheerSound").play();
                        }
                        q("#restartBtn1").style.display = "inline-block";
                        q("#returnBtn1").style.display = "inline-block";
                    }).catch(error => {
                        console.error("Error saving score:", error);
                        fbk1.textContent = lang === "en" ? "Error saving to leaderboard." : "ç„¡æ³•ä¿å­˜åˆ°æ’è¡Œæ¦œã€‚";
                        q("#restartBtn1").style.display = "inline-block";
                        q("#returnBtn1").style.display = "inline-block";
                    });
                }
            }, 1000);
        }

        function startGame1() {
            score1 = 0;
            timeLeft1 = 60;
            mistakes1 = [];
            myLastScore1 = null;
            isPaused1 = false;
            updateScore1();
            updateTimer1();
            mistakesDiv1.style.display = "none";
            leaderDiv1.style.display = "none";
            leaderList1.innerHTML = "";
            noLeaderData1.style.display = "none";
            q("#restartBtn1").style.display = "none";
            q("#returnBtn1").style.display = "none";
            q("#pauseOverlay1").style.display = "none";
            ansInp1.disabled = false;
            fbk1.textContent = "";
            generateQuestion1();
            startTimer1();
        }

        ansInp1.addEventListener("input", e => {
            const val = parseInt(e.target.value, 10);
            if (!isNaN(val)) checkAnswer1(val);
        });

        q("#mistakeBtn1").addEventListener("click", () => {
            if (mistakesDiv1.style.display === "block") {
                mistakesDiv1.style.display = "none";
            } else {
                showMistakes1();
            }
        });

        q("#leaderBtn1").addEventListener("click", () => {
            if (leaderDiv1.style.display === "block") {
                leaderDiv1.style.display = "none";
                noLeaderData1.style.display = "none";
            } else {
                refreshLeaderboard1();
                mistakesDiv1.style.display = "none";
            }
        });

        q("#pauseBtn1").addEventListener("click", () => {
            isPaused1 = true;
            clearInterval(timer1);
            q("#pauseOverlay1").style.display = "block";
        });

        q("#resumeBtn1").addEventListener("click", () => {
            isPaused1 = false;
            q("#pauseOverlay1").style.display = "none";
            startTimer1();
        });

        q("#restartBtn1").addEventListener("click", startGame1);

        q("#returnBtn1").addEventListener("click", () => {
            window.location.href = 'mathgameindex.html';
        });

        const TARGET_SCORE2 = 100, CORRECT_POINTS2 = 3, WRONG_POINTS2 = -1;
        let score2 = 0, timeUsed2 = 0, bestTime2 = parseFloat(localStorage.getItem("bestTime2")) || null, timer2, mistakes2 = [], num1_2, num2_2, myLastTime2 = null;
        let isPaused2 = false, gameStarted2 = false;
        const num1El2 = q("#num1_2"), num2El2 = q("#num2_2"), ansInp2 = q("#answerInput2"),
              scoreEl2 = q("#score2"), timeEl2 = q("#timeUsed2"), bestEl2 = q("#bestTime2"), fbk2 = q("#feedback2"),
              progressBar2 = q("#progressBar2"), mistakesDiv2 = q("#mistakes2"), leaderDiv2 = q("#leaderboard2"),
              leaderList2 = q("#leaderList2"), noLeaderData2 = q("#noLeaderData2");

        function updateScore2() {
            const lang = q("#langSelect").value;
            scoreEl2.innerHTML = `<span id="scoreText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Score: </span><span id="scoreText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å¾—åˆ†: </span>${score2}`;
            progressBar2.style.width = `${(score2 / TARGET_SCORE2) * 100}%`;
        }

        function updateTimer2() {
            const lang = q("#langSelect").value;
            timeEl2.innerHTML = `<span id="timeUsedText2_en" style="display:${lang === 'en' ? 'inline' : 'none'}">Time Used: </span><span id="timeUsedText2_zh" style="display:${lang === 'zh' ? 'inline' : 'none'}">å·²ç”¨æ™‚é–“: </span>${timeUsed2.toFixed(1)}â€¯s`;
        }

        function generateQuestion2() {
            num1_2 = Math.floor(Math.random() * 9) + 1;
            num2_2 = Math.floor(Math.random() * 9) + 1;
            num1El2.textContent = num1_2;
            num2El2.textContent = num2_2;
            ansInp2.value = "";
            ansInp2.focus();
            fbk2.textContent = "";
        }
function checkAnswer2(userAnswer) {
            if (ansInp2.value.length < 1) return;
            const correctAnswer = num1_2 + num2_2;
            if (!isNaN(userAnswer) && userAnswer === correctAnswer) {
                const correctEmojis = ['ğŸŸ', 'âœ¨', 'ğŸ‰'];
                const randomCorrect = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                fbk2.innerHTML = userAnswer + ' <span class="correct">âœ”' + randomCorrect + '</span>';
                score2 += CORRECT_POINTS2;
                updateScore2();
                playRandomCorrectSound();
                if (score2 >= TARGET_SCORE2) {
                    clearInterval(timer2);
                    const lang = q("#langSelect").value;
                    fbk2.textContent = lang === "en" ? "You did it! ğŸ‰" : "ä½ æˆåŠŸäº†ï¼ğŸ‰";
                    ansInp2.disabled = true;
                    myLastTime2 = timeUsed2;
                    db.ref("times").push({ name: username, time: timeUsed2, timestamp: Date.now() }).then(() => {
                        refreshLeaderboard2();
                        if (!bestTime2 || timeUsed2 < bestTime2) {
                            bestTime2 = timeUsed2;
                            localStorage.setItem("bestTime2", bestTime2);
                            bestEl2.innerHTML = `<span id="bestTimeText2_en">Best Time: </span><span id="bestTimeText2_zh" style="display:none">æœ€ä½³æ™‚é–“: </span>${bestTime2.toFixed(2)} s`;
                            if (soundEnabled) q("#cheerSound").play();
                        }
                        q("#restartBtn2").style.display = "inline-block";
                        q("#returnBtn2").style.display = "inline-block";
                    }).catch(error => {
                        console.error("Error saving time:", error);
                        fbk2.textContent = lang === "en" ? "Error saving to leaderboard." : "ç„¡æ³•ä¿å­˜åˆ°æ’è¡Œæ¦œã€‚";
                        q("#restartBtn2").style.display = "inline-block";
                        q("#returnBtn2").style.display = "inline-block";
                    });
                    return;
                }
            } else {
                const wrongEmojis = ['ğŸ˜µ', 'ğŸ’¦'];
                const randomWrong = wrongEmojis[Math.floor(Math.random() * wrongEmojis.length)];
                fbk2.innerHTML = userAnswer + ' <span class="incorrect">âœ˜' + randomWrong + '</span>';
                mistakes2.push({
                    question: `${num1_2} + ${num2_2}`,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer
                });
                score2 = Math.max(0, score2 + WRONG_POINTS2);
                updateScore2();
            }
            setTimeout(generateQuestion2, 500);
        }

        function showMistakes2() {
            const lang = q("#langSelect").value;
            mistakesDiv2.innerHTML = `<h3><span id="mistakesTitle2_en" style="display:${lang === 'en' ? 'block' : 'none'}">âŒ Mistakes</span><span id="mistakesTitle2_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">âŒ éŒ¯é¡Œ</span></h3>`;
            if (mistakes2.length === 0) {
                mistakesDiv2.innerHTML += `<p><span id="noMistakes2_en" style="display:${lang === 'en' ? 'block' : 'none'}">No mistakes! ğŸ‰</span><span id="noMistakes2_zh" style="display:${lang === 'zh' ? 'block' : 'none'}">æ²’æœ‰éŒ¯èª¤ï¼ğŸ‰</span></p>`;
            } else {
                mistakes2.forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `${m.question} = <span class="wrong">${m.userAnswer}</span>, <span class="correct">${m.correctAnswer}</span>`;
                    mistakesDiv2.appendChild(div);
                });
            }
            mistakesDiv2.style.display = "block";
            leaderDiv2.style.display = "none";
        }

        function refreshLeaderboard2() {
            db.ref("times").orderByChild("time").limitToFirst(5).once("value").then(snap => {
                const arr = [];
                snap.forEach(ch => {
                    const val = ch.val();
                    if (val && val.name && typeof val.time === "number" && !isNaN(val.time) && val.timestamp) {
                        arr.push(val);
                    }
                });

                const virtualData2 = [
                    { name: "Alex", time: 85.2, timestamp: Date.now() - 1000 },
                    { name: "æ˜", time: 98.1, timestamp: Date.now() - 2000 },
                    { name: "Kitty Chow", time: 115.7, timestamp: Date.now() - 3000 },
                    { name: "Tommy Lee", time: 123.5, timestamp: Date.now() - 4000 },
                    { name: "å‘€å¯¶", time: 159.7, timestamp: Date.now() - 5000 }
                ];
                const neededEntries = 5 - arr.length;
                if (neededEntries > 0) {
                    arr.push(...virtualData2.slice(0, neededEntries));
                }

                arr.sort((a, b) => a.time - b.time || a.timestamp - b.timestamp);
                if (arr.length === 0) {
                    leaderList2.innerHTML = "";
                    noLeaderData2.style.display = "block";
                } else {
                    leaderList2.innerHTML = "";
                    const ranks = [];
                    let currentRank = 1;
                    for (let i = 0; i < arr.length; i++) {
                        if (i === 0) {
                            ranks[i] = currentRank;
                        } else if (arr[i].time === arr[i - 1].time) {
                            ranks[i] = ranks[i - 1];
                        } else {
                            ranks[i] = i + 1;
                            currentRank = i + 1;
                        }
                    }
                    arr.slice(0, 5).forEach((entry, i) => {
                        const li = document.createElement("li");
                        const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "";
                        li.textContent = `${ranks[i]}. ${entry.name} â€“ ${entry.time.toFixed(1)}s ${medal}`;
                        if (entry.name === username && entry.time === myLastTime2) {
                            li.classList.add("me");
                        }
                        leaderList2.appendChild(li);
                    });
                    noLeaderData2.style.display = "none";
                }
                leaderDiv2.style.display = "block";
            }).catch(error => {
                console.error("Error fetching leaderboard:", error);
                leaderList2.innerHTML = "";
                noLeaderData2.style.display = "block";
            });
        }

        function startTimer2() {
            timer2 = setInterval(() => {
                if (isPaused2) return;
                timeUsed2 += 0.1;
                updateTimer2();
            }, 100);
        }

        function startGame2() {
            score2 = 0;
            timeUsed2 = 0;
            mistakes2 = [];
            myLastTime2 = null;
            isPaused2 = false;
            gameStarted2 = true;
            updateScore2();
            updateTimer2();
            mistakesDiv2.style.display = "none";
            leaderDiv2.style.display = "none";
            leaderList2.innerHTML = "";
            noLeaderData2.style.display = "none";
            q("#restartBtn2").style.display = "none";
            q("#returnBtn2").style.display = "none";
            q("#pauseOverlay2").style.display = "none";
            ansInp2.disabled = false;
            fbk2.textContent = "";
            generateQuestion2();
            startTimer2();
        }

        ansInp2.addEventListener("input", e => {
            const val = parseInt(e.target.value, 10);
            if (!isNaN(val)) checkAnswer2(val);
        });

        q("#mistakeBtn2").addEventListener("click", () => {
            if (mistakesDiv2.style.display === "block") {
                mistakesDiv2.style.display = "none";
            } else {
                showMistakes2();
            }
        });

        q("#leaderBtn2").addEventListener("click", () => {
            if (leaderDiv2.style.display === "block") {
                leaderDiv2.style.display = "none";
                noLeaderData2.style.display = "none";
            } else {
                refreshLeaderboard2();
                mistakesDiv2.style.display = "none";
            }
        });

        q("#pauseBtn2").addEventListener("click", () => {
            isPaused2 = true;
            clearInterval(timer2);
            q("#pauseOverlay2").style.display = "block";
        });

        q("#resumeBtn2").addEventListener("click", () => {
            isPaused2 = false;
            q("#pauseOverlay2").style.display = "none";
            startTimer2();
        });

        q("#restartBtn2").addEventListener("click", startGame2);

        q("#returnBtn2").addEventListener("click", () => {
            window.location.href = 'mathgameindex.html';
        });

        const urlParams = new URLSearchParams(window.location.search);
        const gameMode = urlParams.get('game');
        if (gameMode === '1') {
            q("#gameSelection").style.display = "none";
            q("#game1").style.display = "block";
            startGame1();
        } else if (gameMode === '2') {
            q("#gameSelection").style.display = "none";
            q("#game2").style.display = "block";
            startGame2();
        }

        switchLang();
    </script>
</body>
</html>